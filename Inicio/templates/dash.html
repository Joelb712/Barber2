{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{% block title %}Dashboard{% endblock %}</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

    <!-- Tu CSS -->
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    
    {% block extra_head %}{% endblock %}
</head>
<body class="antialiased">

  <!-- Overlay mobile -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <!-- Sidebar -->
  <nav id="sidebar" class="" aria-label="Sidebar">
    <div class="sidebar-header">
      <div class="logo-img">
        <img src="{% static 'imgs/logofede.png' %}" alt="Logo" class="w-6 h-6 object-cover">
      </div>
      <div class="logo-text">
        <div>FEDE BARBERSHOP</div>
        <div style="font-size:10px; opacity:.8">Sistema de Gestión</div>
      </div>
    </div>

    <ul class="sidebar-menu">
      <!-- MANTENGO data-name/data-icon para breadcrumb y compatibilidad -->
      <li class="menu-item">
        <a href="{% url 'home' %}" class="menu-link active" data-name="Home" data-icon="fa-house">
          <i class="fas fa-house"></i><span class="menu-text">Home</span>
        </a>
      </li>
      {% if empleadito.especialidad == 'gerente' or request.user.is_superuser%}
      <li class="menu-item">
        <!-- CAMBIO: uso href con tu url Django (igual que tenías) -->
        <a href="{% url 'lista_empleados' %}" class="menu-link" data-name="Empleados" data-icon="fa-users">
          <i class="fas fa-users"></i><span class="menu-text">Empleados</span>
        </a>
      </li>
      {% endif%}
      {% if empleadito.especialidad == 'gerente' or empleadito.especialidad == 'recepcionista' or request.user.is_superuser%}
      <li class="menu-item">
        <a href="{% url 'lista_clientes' %}" class="menu-link" data-name="Clientes" data-icon="fa-user">
          <i class="fas fa-user"></i><span class="menu-text">Clientes</span>
        </a>
      </li>
      {% endif %}
      {% if empleadito.especialidad == 'gerente' or empleadito.especialidad == 'recepcionista' or request.user.is_superuser%}
      <li class="menu-item">
        <a href="{% url 'lista_ventas' %}" class="menu-link" data-name="Ventas" data-icon="fa-dollar-sign">
          <i class="fas fa-dollar-sign"></i><span class="menu-text">Ventas</span>
        </a>
      </li>
      {% endif%}
      {% if empleadito.especialidad == 'gerente' or empleadito.especialidad == 'recepcionista' or request.user.is_superuser%}
      <li class="menu-item">
        <a href="{% url 'turnos' %}" class="menu-link" data-name="Turnos" data-icon="fa-calendar-check">
          <i class="fas fa-calendar-check"></i><span class="menu-text">Turnos</span>
        </a>
      </li>
      {% endif %}
      {% if empleadito.especialidad == 'gerente' or request.user.is_superuser %}
      <li class="menu-item">
        <a href="{% url 'lista_horarios' %}" class="menu-link" data-name="Horarios" data-icon="fa-clock">
          <i class="fas fa-clock"></i><span class="menu-text">Horarios</span>
        </a>
      </li>
      {% endif %}
      {% if empleadito.especialidad == 'gerente' or empleadito.especialidad == 'recepcionista' or request.user.is_superuser%}
      <li class="menu-item">
        <a href="{% url 'cajas' %}" class="menu-link" data-name="Cajas" data-icon="fa-cash-register">
          <i class="fas fa-cash-register"></i><span class="menu-text">Cajas</span>
        </a>
      </li>
      {% endif%}
      {% if empleadito.especialidad == 'gerente' or request.user.is_superuser %}
      <li class="menu-item">
        <a href="{% url 'metodos' %}" class="menu-link" data-name="Metodos de Pago" data-icon="fa-credit-card">
          <i class="fas fa-credit-card"></i><span class="menu-text">Métodos de Pago</span>
        </a>
      </li>
      {% endif%}
      {% if empleadito.especialidad == 'gerente' or empleadito.especialidad == 'recepcionista' or request.user.is_superuser%}
      <li class="menu-item">
        <a href="{% url 'lista_productos' %}" class="menu-link" data-name="Productos" data-icon="fa-archive">
          <i class="fas fa-archive"></i><span class="menu-text">Productos</span>
        </a>
      </li>
      {% endif %}
      {% if empleadito.especialidad == 'gerente' or empleadito.especialidad == 'recepcionista' or request.user.is_superuser%}
      <li class="menu-item">
        <a href="{% url 'lista_servicios' %}" class="menu-link" data-name="Servicios" data-icon="fa-scissors">
          <i class="fas fa-scissors"></i><span class="menu-text">Servicios</span>
        </a>
      </li>
      {% endif %}
    </ul>
    <!-- PERFIL EXPANDIDO -->
    <div class="sidebar-profile expanded text-center border-t border-neutral-700 bg-[#1a1a1a] p-4 text-neutral-200">
      <div class="w-16 h-16 mx-auto mb-3 rounded-full overflow-hidden border-2 border-yellow-400">
        {% if user.empleado.foto %}
          <img src="{{ user.empleado.foto.url }}" alt="Foto" class="w-full h-full object-cover">
        {% else %}
          <img src="{% static 'imgs/default-profile.png' %}" alt="Foto" class="w-full h-full object-cover">
        {% endif %}
      </div>
      <p class="text-sm font-semibold text-yellow-400 truncate">{{ user.username }}</p>
      <p class="text-xs text-neutral-400 mb-3 truncate">{{ user.email }}</p>

      <div class="flex flex-col gap-2 mt-3">
        <a href="{% url 'Inicio' %}" class="text-gray-400 hover:text-yellow-400 text-xs">
          <i class="fa fa-home mr-1"></i>Volver al inicio
        </a>

        <a href="#" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-neutral-900 font-semibold py-1.5 rounded transition">
          Ver perfil
        </a>

        <form method="POST" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit" class="w-full text-xs bg-neutral-700 hover:bg-red-700 text-neutral-200 py-1.5 rounded transition">
            <i class="fa fa-right-from-bracket mr-1"></i> Cerrar sesión
          </button>
        </form>
      </div>
    </div>

    <!-- PERFIL COLAPSADO -->
    <div class="sidebar-profile collapsed text-center border-t border-neutral-700 bg-[#1a1a1a] p-3 hidden">
      <div class="w-10 h-10 mx-auto rounded-full overflow-hidden border-2 border-yellow-400 mb-2">
        {% if user.empleado.foto %}
          <img src="{{ user.empleado.foto.url }}" alt="Foto" class="w-full h-full object-cover">
        {% else %}
          <img src="{% static 'imgs/default-profile.png' %}" alt="Foto" class="w-full h-full object-cover">
        {% endif %}
      </div>

      <form method="POST" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit" class="bg-neutral-700 hover:bg-red-700 text-neutral-200 rounded-full w-9 h-9 flex items-center justify-center transition">
          <i class="fa fa-right-from-bracket text-sm"></i>
        </button>
      </form>
    </div>
  </nav>

  <!-- Main -->
  <main id="mainContent" class="min-h-screen bg-neutral-900">
    <!-- Top Navigation -->
    <div class="top-nav flex items-center justify-between px-4 py-3 ">
      <div class="flex items-center gap-3">
        <!-- CAMBIO: único botón para mobile (abre overlay) y desktop (colapsa) según width -->
        <button class="menu-toggle text-yellow-400  rounded" id="btnToggleSidebar" aria-label="toggle sidebar">
          <i class="fas fa-bars"></i>
        </button>

        <nav aria-label="breadcrumb" class="text-sm text-yellow-400 flex items-center gap-2">
          <a href="#"><i id="breadcrumb-icon"></i></a>
          <span id="breadcrumb-text" class="font-medium">Home</span>
        </nav>
      </div>
    </div>

    <div id="content-area" class="p-4 bg-neutral-900">
      {% block content %}
      <!-- Contenido AJAX -->
      {% endblock %}
    </div>
  </main>
  <!-- Modal genérico AJAX -->
  <div id="tailwindModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-neutral-900 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="p-4 border-b border-yellow-500 flex justify-between items-center">
            <h3 id="modalTitle" class="text-lg font-semibold text-yellow-500 flex-1 text-center">Formulario</h3>
            <button id="closeModalBtn" class="text-white hover:text-yellow-500">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="modalBody" class="flex-1 overflow-y-auto p-4">
            <!-- Aquí se inyectará el formulario por AJAX -->
        </div>
    </div>
  </div>


  <!-- SCRIPTS -->
  <script>
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const overlay = document.getElementById('overlay');
    const btnToggle = document.getElementById('btnToggleSidebar');

    // ========================
    // RESET CONTEXTO
    // ========================
    function resetContexto() {
      const content = document.getElementById('content-area');
      $(content).find('table.dataTable').each(function() {
        if ($.fn.DataTable.isDataTable(this)) $(this).DataTable().destroy(true);
      });
      content.innerHTML = '';
    }
    // ========================
    // Utility: actualizar margen del main
    // ========================
    function updateMain() {
      if (window.innerWidth <= 768) {
        mainContent.style.marginLeft = '0';
        return;
      }
      mainContent.style.marginLeft = sidebar.classList.contains('collapsed') ? '70px' : '280px';
    }

    // ========================
    // Toggle sidebar
    // ========================
    btnToggle.addEventListener('click', function() {
      if (window.innerWidth <= 768) {
        const opened = sidebar.classList.toggle('show');
        overlay.classList.toggle('show', opened);
        document.body.style.overflow = opened ? 'hidden' : '';
      } else {
        sidebar.classList.toggle('collapsed');
        if (sidebar.classList.contains('collapsed')) closeAllSubmenus();
        updateMain();
      }
    });

    // overlay click close mobile sidebar
    overlay.addEventListener('click', () => {
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
      document.body.style.overflow = '';
    });
    
    // on resize: limpiar estados mobile/desktop y forzar recálculo
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
        document.body.style.overflow = '';
      }
      updateMain();
    });

    // ========================
    // Submenus
    // ========================
    function toggleSubmenu(button) {
      const li = button.parentElement;
      const submenu = li.querySelector('.submenu');
      if (!submenu) return;
      if (sidebar.classList.contains('collapsed') && window.innerWidth > 768) return;

      const isOpen = li.classList.contains('expanded');
      document.querySelectorAll('.menu-item.expanded').forEach(other => {
        if (other !== li) closeSubmenu(other);
      });

      isOpen ? closeSubmenu(li) : openSubmenu(li);
    }

    function openSubmenu(li) {
      const submenu = li.querySelector('.submenu');
      if (!submenu) return;
      submenu.style.display = 'block';
      const h = submenu.scrollHeight;
      submenu.style.maxHeight = '0px';
      requestAnimationFrame(() => { submenu.style.maxHeight = h + 'px'; });
      li.classList.add('expanded');
      submenu.addEventListener('transitionend', function handler() {
        if (li.classList.contains('expanded')) submenu.style.maxHeight = 'none';
        submenu.removeEventListener('transitionend', handler);
      });
    }

    function closeSubmenu(li) {
      const submenu = li.querySelector('.submenu');
      if (!submenu) return;
      if (getComputedStyle(submenu).maxHeight === 'none') submenu.style.maxHeight = submenu.scrollHeight + 'px';
      requestAnimationFrame(() => { submenu.style.maxHeight = '0px'; });
      li.classList.remove('expanded');
      submenu.addEventListener('transitionend', function handler() {
        submenu.style.display = '';
        submenu.style.maxHeight = '';
        submenu.removeEventListener('transitionend', handler);
      });
    }

    function closeAllSubmenus() {
      document.querySelectorAll('.menu-item.expanded').forEach(closeSubmenu);
    }

    // ========================
    // Breadcrumb
    // ========================
    function updateBreadcrumb(name, iconClass) {
      const iconEl = document.getElementById('breadcrumb-icon');
      const textEl = document.getElementById('breadcrumb-text');
      if (iconEl && textEl) {
        iconEl.innerHTML = '<i class="fas ' + iconClass + '"></i>';
        textEl.textContent = name;
      }
    }

    // ========================
    // AJAX de CargarContenido que actualiza el contenido de principal
    // ========================
    function cargarContenido(url, nombre = "", icono = "fa-folder") {
      $.ajax({
        url: url,
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        xhrFields: { withCredentials: true },
        success: function(respuesta, status, jqXHR) {
          // Si devolvió página completa, redirigimos
          if (typeof respuesta === 'string' && (respuesta.includes('<html') || respuesta.includes('<head'))) {
            window.location.href = url;
            return;
          }

          // Si devolvió login (form de login) -> redirigir a login
          if (respuesta.includes('name="username"') && respuesta.includes('name="password"')) {
            window.location.href = "{% url 'login' %}";
            return;
          }

          // Caso normal: inyectar contenido
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = respuesta;

            // 👇 Ejecutar scripts manualmente
            contentArea.querySelectorAll('script').forEach(oldScript => {
            const newScript = document.createElement('script');
            if (oldScript.src) {
                newScript.src = oldScript.src;
            } else {
                newScript.textContent = oldScript.textContent;
            }
            oldScript.parentNode.replaceChild(newScript, oldScript);
            });

          // actualizamos breadcrumb con lo que pasamos
          if (nombre) updateBreadcrumb(nombre, icono);
        },
        // Opcional mostrar mensaje al usuario
        error: function(error) {
          console.error('Error al cargar contenido:', error);
        }
      });
    }

    //=============================
    // SIN ESTO LOS SUBMENUS REDIRIGEN EN VEZ DE CARGARSE EN EL CONTENT-AREA
    //=============================
    // activar links del menu principal (excluyendo botones de submenu)
    document.querySelectorAll('.menu-link').forEach(link => {
      // Si el link es un button (submenu toggle) lo dejamos (tiene onclick)
      if (link.tagName.toLowerCase() === 'button') return;
      link.addEventListener('click', function(e) {
        // Evitar navegación por defecto si href="#" o manejo AJAX
        // e.preventDefault(); // NO prevenir si es una url real a cargar via AJAX - lo maneja cargarContenido
        // visual active
        document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');

        // Actualizar breadcrumb (si data-name/data-icon están presentes)
        const name = this.dataset.name || this.querySelector('.menu-text')?.textContent?.trim() || 'Home';
        const icon = this.dataset.icon || 'fa-house';
        updateBreadcrumb(name, icon);
      });
    });

    // submenu-links (estas van a llamar a AJAX)
    document.querySelectorAll('.submenu-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        // visual
        document.querySelectorAll('.submenu-link').forEach(s => s.classList.remove('active'));
        this.classList.add('active');

        // cargar por AJAX si tiene href != '#'
        const url = this.getAttribute('href');
        const nombre = this.dataset.nombre || this.textContent.trim();
        const icono = this.dataset.icono || 'fa-folder';

        if (url && url !== '#') {
          cargarContenido(url, nombre, icono);
        }
        // cerrar sidebar en mobile
        if (window.innerWidth <= 768) {
          sidebar.classList.remove('show');
          overlay.classList.remove('show');
          document.body.style.overflow = '';
        }
      });
    });

    //============================
    //  EVENTOS DEL SIDEBAR         
    //============================
    // también habilito que al clickear links del menú principal que tienen href (no '#'),
    // use la misma lógica AJAX (como en tu plantilla original).
    document.querySelectorAll('.menu-link[href]').forEach(link => {
      // saltar botones de submenu
      if (link.tagName.toLowerCase() === 'button') return;
      link.addEventListener('click', function(e) {
        const url = link.getAttribute('href');
        // si url existe y no es '#', usamos AJAX
        if (url && url !== '#') {
          e.preventDefault();
          const nombre = link.dataset.name || link.querySelector('.menu-text')?.textContent?.trim() || "Home";
          const icono = link.dataset.icon || 'fa-house';
          cargarContenido(url, nombre, icono);

          // en mobile cerramos la sidebar
          if (window.innerWidth <= 768) {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
          }
        }
      });
    });

    // Limpieza inicial al cargar
    window.addEventListener('DOMContentLoaded', function() {
      // Asegurar estado limpio
      closeAllSubmenus();
      updateMain();
    });

    // ========================
    // Delegación botones editar/eliminar
    // ========================
    $('#content-area').off('click').on('click', '.btnEditar', function() {
      const id = $(this).data('id');
      // Aquí abrís modal si querés
    });

    $('#content-area').on('click', '.btnEliminar', function() {
      const id = $(this).data('id');
      // Confirmar y eliminar
    });

    // Delegación global para botones que abren formularios en modal
    $(document).on('click', '.btn-ajax-form', function() {
        const url = $(this).data('url');
        const titulo = $(this).data('titulo') || 'Formulario';
        abrirModalAjax(url, titulo);
    });

    // ========================
    // Modal AJAX
    // ========================
    function abrirModalAjax(url, titulo = "Formulario") {
      $.ajax({
        url: url,
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function(respuesta) {
          const modal = $('#tailwindModal');
          modal.find('#modalTitle').text(titulo);
          modal.find('#modalBody').html(respuesta);
          modal.removeClass('hidden').addClass('flex');
        },
        error: function() { alert('Error al cargar el formulario.'); }
      });
    }

    $('#closeModalBtn').on('click', cerrarModalAjax);
    
    function cerrarModalAjax() {
      const modal = $('#tailwindModal');
      modal.addClass('hidden').removeClass('flex');
      modal.find('#modalBody').empty();

      // 👇 Recargar tabla del módulo específico
      recargarTabla('#tablaClientes');  // para clientes
      recargarTabla('#tablaEmpleados'); // para empleados
      recargarTabla('#tablaHorarios');
      recargarTabla('#tablaTurnos');
      recargarTabla('#tablaCajas');
      recargarTabla('#tablaMetodos');
      recargarTabla('#tablaVentas');
      recargarTabla('#tablaProductos');
      recargarTabla('#tablaServicios');
    }
    function recargarTabla(divSelector) {
      const div = $(divSelector);
      const url = div.data('url'); // URL donde se genera la tabla
      if (!url) return;

      $.ajax({
          url: url,
          method: 'GET',
          success: function(html) {
              div.html(html);
          },
          error: function(err) {
              console.error('Error recargando tabla:', err);
          }
      });
    }

    $(document).on('submit', '.ajax-form', function(e) {
      e.preventDefault();
      const form = $(this);
      $.ajax({
        url: form.attr('action'),
        method: form.attr('method'),
        data: form.serialize(),
        success: function(data) {
          if (data.success) {
            cerrarModalAjax();
          } else if (data.next_url) {
            abrirModalAjax(data.next_url, 'Registrar Pago');
          } else {
            $('#modalBody').html(data);
          }
        },
        error: function(xhr) { $('#modalBody').html(xhr.responseText); }
      });
    });

    $(document).on('click', '.btnAbrirCaja', function() {
      const url = $(this).data('url');
      $.ajax({
        url: url,
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function(respuesta) {
            // Aquí sabemos que es JSON con html
            $('#tailwindModal #modalTitle').text('Abrir Caja');
            $('#tailwindModal #modalBody').html(respuesta.html);
            $('#tailwindModal').removeClass('hidden').addClass('flex');
        },
        error: function() { alert('Error al cargar el modal de apertura de caja.'); }
      });
    });

    $(document).on('click', '.btnCerrarCaja', function() {
        const url = $(this).data('url');
        $.ajax({
            url: url,
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            success: function(respuesta) {
                $('#tailwindModal #modalTitle').text('Cerrar Caja');
                $('#tailwindModal #modalBody').html(respuesta.html);
                $('#tailwindModal').removeClass('hidden').addClass('flex');
            },
            error: function() { alert('Error al cargar el modal de cierre de caja.'); }
        });
    });

    $(document).on('submit', '.ajax-form-prod', function(e) {
      e.preventDefault();

      const form = $(this)[0];  // referencia al formulario nativo (no jQuery)
      const formData = new FormData(form);  // recoge todos los campos, incluido el archivo

      $.ajax({
        url: $(form).attr('action'),
        method: $(form).attr('method'),
        data: formData,
        processData: false,   // ⚠️ necesario para FormData
        contentType: false,   // ⚠️ necesario para FormData
        success: function() {
          cerrarModalAjax();
        },
        error: function(xhr) {
          $('#modalBody').html(xhr.responseText);
        }
      });
    });

    $(document).on('click', '#home', function(e) {
        e.preventDefault();
        const url = $(this).data('url');
        cargarContenido(url);
    });

    function cargarContenido(url) {
        $.ajax({
            url: url,
            method: 'GET',
            success: function(respuesta) {
                $('#content-area').html(respuesta);
            },
            error: function() {
                alert('Error al cargar el contenido.');
            }
        });
    }
  </script>

  {% block extra_js %}
  <!-- Aquí cargan scripts específicos de cada vista -->
  {% endblock %}
</body>
</html>
