{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{% block title %}Dashboard{% endblock %}</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

    <!-- Tu CSS -->
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    {% block extra_head %}{% endblock %}
</head>
<body class="antialiased">

  <!-- Overlay mobile -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <!-- Sidebar -->
  <nav id="sidebar" class="" aria-label="Sidebar">
    <div class="sidebar-header">
      <div class="logo-img">
        <img src="{% static 'imgs/logofede.png' %}" alt="Logo" class="w-6 h-6 object-cover">
      </div>
      <div class="logo-text">
        <div>FEDE BARBERSHOP</div>
        <div style="font-size:10px; opacity:.8">Sistema de Gesti贸n</div>
      </div>
    </div>

    <ul class="sidebar-menu">
      <!-- MANTENGO data-name/data-icon para breadcrumb y compatibilidad -->
      <li class="menu-item">
        <a href="{% url 'home' %}" class="menu-link active" data-name="Home" data-icon="fa-house">
          <i class="fas fa-house"></i><span class="menu-text">Home</span>
        </a>
      </li>
      {% if empleadito.especialidad == 'Barbero'%}
      <li class="menu-item">
        <a href="{% url 'historial_turnos' %}" class="menu-link" data-name="Mis Turnos" data-icon="fa-calendar-check">
          <i class="fas fa-calendar-check"></i><span class="menu-text">Mis Turnos</span>
        </a>
      {% endif %}
      {% if empleadito.especialidad == 'Gerente' or request.user.is_superuser%}
      <li class="menu-item">
        <!-- CAMBIO: uso href con tu url Django (igual que ten铆as) -->
        <a href="{% url 'lista_empleados' %}" class="menu-link" data-name="Empleados" data-icon="fa-users">
          <i class="fas fa-users"></i><span class="menu-text">Empleados</span>
        </a>
      </li>
      {% endif%}
      {% if empleadito.especialidad == 'Gerente' or empleadito.especialidad == 'Recepcionista' or request.user.is_superuser%}
      <li class="menu-item">
        <a href="{% url 'lista_clientes' %}" class="menu-link" data-name="Clientes" data-icon="fa-user">
          <i class="fas fa-user"></i><span class="menu-text">Clientes</span>
        </a>
      </li>
      {% endif %}
      {% if empleadito.especialidad == 'Gerente' or empleadito.especialidad == 'Recepcionista' or request.user.is_superuser%}
      <li class="menu-item">
        <a href="{% url 'lista_ventas' %}" class="menu-link" data-name="Ventas" data-icon="fa-dollar-sign">
          <i class="fas fa-dollar-sign"></i><span class="menu-text">Ventas</span>
        </a>
      </li>
      {% endif%}
      {% if empleadito.especialidad == 'Gerente' or empleadito.especialidad == 'Recepcionista' or request.user.is_superuser%}
      <li class="menu-item">
        <a href="{% url 'turnos' %}" class="menu-link" data-name="Turnos" data-icon="fa-calendar-check">
          <i class="fas fa-calendar-check"></i><span class="menu-text">Turnos</span>
        </a>
      </li>
      {% endif %}
      {% if empleadito.especialidad == 'Gerente' or request.user.is_superuser %}
      <li class="menu-item">
        <a href="{% url 'lista_horarios' %}" class="menu-link" data-name="Horarios" data-icon="fa-clock">
          <i class="fas fa-clock"></i><span class="menu-text">Horarios</span>
        </a>
      </li>
      {% endif %}
      {% if empleadito.especialidad == 'Gerente' or empleadito.especialidad == 'Recepcionista' or request.user.is_superuser%}
      <li class="menu-item">
        <a href="{% url 'cajas' %}" class="menu-link" data-name="Cajas" data-icon="fa-cash-register">
          <i class="fas fa-cash-register"></i><span class="menu-text">Cajas</span>
        </a>
      </li>
      {% endif%}
      {% if empleadito.especialidad == 'Gerente' or request.user.is_superuser %}
      <li class="menu-item">
        <a href="{% url 'metodos' %}" class="menu-link" data-name="Metodos de Pago" data-icon="fa-credit-card">
          <i class="fas fa-credit-card"></i><span class="menu-text">M茅todos de Pago</span>
        </a>
      </li>
      {% endif%}
      {% if empleadito.especialidad == 'Gerente' or empleadito.especialidad == 'Recepcionista' or request.user.is_superuser%}
      <li class="menu-item">
        <a href="{% url 'lista_productos' %}" class="menu-link" data-name="Productos" data-icon="fa-archive">
          <i class="fas fa-archive"></i><span class="menu-text">Productos</span>
        </a>
      </li>
      {% endif %}
      {% if empleadito.especialidad == 'Gerente' or empleadito.especialidad == 'Recepcionista' or request.user.is_superuser%}
      <li class="menu-item">
        <a href="{% url 'lista_servicios' %}" class="menu-link" data-name="Servicios" data-icon="fa-scissors">
          <i class="fas fa-scissors"></i><span class="menu-text">Servicios</span>
        </a>
      </li>
      {% endif %}
    </ul>
    <!-- PERFIL EXPANDIDO -->
    <div class="sidebar-profile expanded text-center border-t border-neutral-700 bg-[#1a1a1a] p-4 text-neutral-200">
      <div class="w-16 h-16 mx-auto mb-3 rounded-full overflow-hidden border-2 border-yellow-400">
        {% if user.empleado.foto %}
          <img src="{{ user.empleado.foto.url }}" alt="Foto" class="w-full h-full object-cover">
        {% else %}
          <img src="{% static 'imgs/default-profile.png' %}" alt="Foto" class="w-full h-full object-cover">
        {% endif %}
      </div>
      <p class="text-sm font-semibold text-yellow-400 truncate">{{ user.username }}</p>
      <p class="text-xs text-neutral-400 mb-3 truncate">{{ user.email }}</p>

      <div class="flex flex-col gap-2 mt-3">
      
        <a href="{% url 'mi_perfil' %}" onclick="event.preventDefault(); cargarContenido(`{% url 'mi_perfil' %}`, 'Mi Perfil', 'fa-user');" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-neutral-900 font-semibold py-1.5 rounded transition">
          Ver perfil
        </a>

        <form method="POST" action="{% url 'logout' %}">
          {% csrf_token %}
          <button type="submit" class="w-full text-xs bg-neutral-700 hover:bg-red-700 text-neutral-200 py-1.5 rounded transition">
            <i class="fa fa-right-from-bracket mr-1"></i> Cerrar sesi贸n
          </button>
        </form>
      </div>
    </div>

    <!-- PERFIL COLAPSADO -->
    <div class="sidebar-profile collapsed text-center border-t border-neutral-700 bg-[#1a1a1a] p-3 hidden">
      <div class="w-10 h-10 mx-auto rounded-full overflow-hidden border-2 border-yellow-400 mb-2">
        {% if user.empleado.foto %}
          <img src="{{ user.empleado.foto.url }}" alt="Foto" class="w-full h-full object-cover">
        {% else %}
          <img src="{% static 'imgs/default-profile.png' %}" alt="Foto" class="w-full h-full object-cover">
        {% endif %}
      </div>

      <form method="POST" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit" class="bg-neutral-700 hover:bg-red-700 text-neutral-200 rounded-full w-9 h-9 flex items-center justify-center transition">
          <i class="fa fa-right-from-bracket text-sm"></i>
        </button>
      </form>
    </div>
  </nav>

  <!-- Main -->
  <main id="mainContent" class="min-h-screen bg-neutral-900">
    <!-- Top Navigation -->
    <div class="top-nav flex items-center justify-between px-4 py-3 ">
      <div class="flex items-center gap-3">
        <!-- CAMBIO: 煤nico bot贸n para mobile (abre overlay) y desktop (colapsa) seg煤n width -->
        <button class="menu-toggle text-yellow-400  rounded" id="btnToggleSidebar" aria-label="toggle sidebar">
          <i class="fas fa-bars"></i>
        </button>

        <nav aria-label="breadcrumb" class="text-sm text-yellow-400 flex items-center gap-2">
          <a href="#"><i id="breadcrumb-icon"></i></a>
          <span id="breadcrumb-text" class="font-medium">Home</span>
        </nav>
      </div>
    </div>

    <div id="content-area" class="p-4 bg-neutral-900">
      {% block content %}
      <!-- Contenido AJAX -->
      {% endblock %}
    </div>
  </main>
  <!-- Modal gen茅rico AJAX -->
  <div id="tailwindModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
    <div id="modalContent" class="bg-neutral-900 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col transition-transform ease-out duration-300 transform scale-95">
        <div class="p-4 border-b border-yellow-500 flex justify-between items-center">
            <h3 id="modalTitle" class="text-lg font-semibold text-yellow-500 flex-1 text-center">Formulario</h3>
            <button id="closeModalBtn" class="text-white hover:text-yellow-500">
                <i class="fas fa-times"></i>
            </button>
        </div> 
        <div id="modalBody" class="flex-1 overflow-y-auto p-4">
            <!-- Aqu铆 se inyectar谩 el formulario por AJAX -->
        </div>
    </div>
  </div>

</div>
  <!-- Contenedor de alertas -->
  <div id="alert-container" class="fixed top-5 right-5 z-[9999] flex flex-col gap-2 w-full max-w-sm pointer-events-none"></div>

  
  <!-- SCRIPTS -->
  <script>
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const overlay = document.getElementById('overlay');
    const btnToggle = document.getElementById('btnToggleSidebar');

    // ========================
    // RESET CONTEXTO
    // ========================
    function resetContexto() {
      const content = document.getElementById('content-area');
      $(content).find('table.dataTable').each(function() {
        if ($.fn.DataTable.isDataTable(this)) $(this).DataTable().destroy(true);
      });
      content.innerHTML = '';
    }
    // ========================
    // Utility: actualizar margen del main
    // ========================
    function updateMain() {
      if (window.innerWidth <= 768) {
        mainContent.style.marginLeft = '0';
        return;
      }
      mainContent.style.marginLeft = sidebar.classList.contains('collapsed') ? '70px' : '280px';
    }

    // ========================
    // Toggle sidebar
    // ========================
    btnToggle.addEventListener('click', function() {
      if (window.innerWidth <= 768) {
        const opened = sidebar.classList.toggle('show');
        overlay.classList.toggle('show', opened);
        document.body.style.overflow = opened ? 'hidden' : '';
      } else {
        sidebar.classList.toggle('collapsed');
        if (sidebar.classList.contains('collapsed')) closeAllSubmenus();
        updateMain();
      }
    });

    // overlay click close mobile sidebar
    overlay.addEventListener('click', () => {
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
      document.body.style.overflow = '';
    });
    
    // on resize: limpiar estados mobile/desktop y forzar rec谩lculo
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
        document.body.style.overflow = '';
      }
      updateMain();
    });

    // ========================
    // Submenus
    // ========================
    function toggleSubmenu(button) {
      const li = button.parentElement;
      const submenu = li.querySelector('.submenu');
      if (!submenu) return;
      if (sidebar.classList.contains('collapsed') && window.innerWidth > 768) return;

      const isOpen = li.classList.contains('expanded');
      document.querySelectorAll('.menu-item.expanded').forEach(other => {
        if (other !== li) closeSubmenu(other);
      });

      isOpen ? closeSubmenu(li) : openSubmenu(li);
    }

    function openSubmenu(li) {
      const submenu = li.querySelector('.submenu');
      if (!submenu) return;
      submenu.style.display = 'block';
      const h = submenu.scrollHeight;
      submenu.style.maxHeight = '0px';
      requestAnimationFrame(() => { submenu.style.maxHeight = h + 'px'; });
      li.classList.add('expanded');
      submenu.addEventListener('transitionend', function handler() {
        if (li.classList.contains('expanded')) submenu.style.maxHeight = 'none';
        submenu.removeEventListener('transitionend', handler);
      });
    }

    function closeSubmenu(li) {
      const submenu = li.querySelector('.submenu');
      if (!submenu) return;
      if (getComputedStyle(submenu).maxHeight === 'none') submenu.style.maxHeight = submenu.scrollHeight + 'px';
      requestAnimationFrame(() => { submenu.style.maxHeight = '0px'; });
      li.classList.remove('expanded');
      submenu.addEventListener('transitionend', function handler() {
        submenu.style.display = '';
        submenu.style.maxHeight = '';
        submenu.removeEventListener('transitionend', handler);
      });
    }

    function closeAllSubmenus() {
      document.querySelectorAll('.menu-item.expanded').forEach(closeSubmenu);
    }

    // ========================
    // Breadcrumb
    // ========================
    function updateBreadcrumb(name, iconClass) {
      const iconEl = document.getElementById('breadcrumb-icon');
      const textEl = document.getElementById('breadcrumb-text');
      if (iconEl && textEl) {
        iconEl.innerHTML = '<i class="fas ' + iconClass + '"></i>';
        textEl.textContent = name;
      }
    }

    // ========================
    // AJAX de CargarContenido que actualiza el contenido de principal
    // ========================
    function cargarContenido(url, nombre = "", icono = "fa-folder") {
      $.ajax({
        url: url,
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        xhrFields: { withCredentials: true },
        success: function(respuesta, status, jqXHR) {
          // Si devolvi贸 p谩gina completa, redirigimos
          if (typeof respuesta === 'string' && (respuesta.includes('<html') || respuesta.includes('<head'))) {
            window.location.href = url;
            return;
          }

          // Si devolvi贸 login (form de login) -> redirigir a login
          if (respuesta.includes('name="username"') && respuesta.includes('name="password"')) {
            window.location.href = "{% url 'login' %}";
            return;
          }

          // Caso normal: inyectar contenido
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = respuesta;
            
            //AQUI SE PUEDEN AGREGAR PARA INICIALIZAR JS ESPECIFICOS SEGUN LA URL
            //consulta si es historial para inicializar js
            if (url.includes("historial")) {
              initHistorial();
            }

            //  Ejecutar scripts manualmente
            contentArea.querySelectorAll('script').forEach(oldScript => {
            const newScript = document.createElement('script');
            if (oldScript.src) {
                newScript.src = oldScript.src;
            } else {
                newScript.textContent = oldScript.textContent;
            }
            oldScript.parentNode.replaceChild(newScript, oldScript);
            });

          // actualizamos breadcrumb con lo que pasamos
          if (nombre) updateBreadcrumb(nombre, icono);
        },
        // Opcional mostrar mensaje al usuario
        error: function(error) {
          console.error('Error al cargar contenido:', error);
        }
      });
    }

    //=============================
    // SIN ESTO LOS SUBMENUS REDIRIGEN EN VEZ DE CARGARSE EN EL CONTENT-AREA
    //=============================
    // activar links del menu principal (excluyendo botones de submenu)
    document.querySelectorAll('.menu-link').forEach(link => {
      // Si el link es un button (submenu toggle) lo dejamos (tiene onclick)
      if (link.tagName.toLowerCase() === 'button') return;
      link.addEventListener('click', function(e) {
        // Evitar navegaci贸n por defecto si href="#" o manejo AJAX
        // e.preventDefault(); // NO prevenir si es una url real a cargar via AJAX - lo maneja cargarContenido
        // visual active
        document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');

        // Actualizar breadcrumb (si data-name/data-icon est谩n presentes)
        const name = this.dataset.name || this.querySelector('.menu-text')?.textContent?.trim() || 'Home';
        const icon = this.dataset.icon || 'fa-house';
        updateBreadcrumb(name, icon);
      });
    });

    // submenu-links (estas van a llamar a AJAX)
    document.querySelectorAll('.submenu-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        // visual
        document.querySelectorAll('.submenu-link').forEach(s => s.classList.remove('active'));
        this.classList.add('active');

        // cargar por AJAX si tiene href != '#'
        const url = this.getAttribute('href');
        const nombre = this.dataset.nombre || this.textContent.trim();
        const icono = this.dataset.icono || 'fa-folder';

        if (url && url !== '#') {
          cargarContenido(url, nombre, icono);
        }
        // cerrar sidebar en mobile
        if (window.innerWidth <= 768) {
          sidebar.classList.remove('show');
          overlay.classList.remove('show');
          document.body.style.overflow = '';
        }
      });
    });

    //============================
    //  EVENTOS DEL SIDEBAR         
    //============================
    // tambi茅n habilito que al clickear links del men煤 principal que tienen href (no '#'),
    // use la misma l贸gica AJAX (como en tu plantilla original).
    document.querySelectorAll('.menu-link[href]').forEach(link => {
      // saltar botones de submenu
      if (link.tagName.toLowerCase() === 'button') return;
      link.addEventListener('click', function(e) {
        const url = link.getAttribute('href');
        // si url existe y no es '#', usamos AJAX
        if (url && url !== '#') {
          e.preventDefault();
          const nombre = link.dataset.name || link.querySelector('.menu-text')?.textContent?.trim() || "Home";
          const icono = link.dataset.icon || 'fa-house';
          cargarContenido(url, nombre, icono);

          // en mobile cerramos la sidebar
          if (window.innerWidth <= 768) {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
          }
        }
      });
    });

    // Limpieza inicial al cargar
    window.addEventListener('DOMContentLoaded', function() {
      // Asegurar estado limpio
      closeAllSubmenus();
      updateMain();
    });

    // ========================
    // Delegaci贸n botones editar/eliminar
    // ========================
    $('#content-area').off('click').on('click', '.btnEditar', function() {
      const id = $(this).data('id');
      // Aqu铆 abr铆s modal si quer茅s
    });

    $('#content-area').on('click', '.btnEliminar', function() {
      const id = $(this).data('id');
      // Confirmar y eliminar
    });

    // Delegaci贸n global para botones que abren formularios en modal
    $(document).on('click', '.btn-ajax-form', function() {
        const url = $(this).data('url');
        const titulo = $(this).data('titulo') || 'Formulario';
        abrirModalAjax(url, titulo);
    });

    // ========================
    // Modal AJAX
    // ========================
    function abrirModalAjax(url, titulo = "Formulario") {
      $.ajax({
        url: url,
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function(respuesta) {
          const modal = $('#tailwindModal');
          const modalContent = $('#modalContent');

          modal.find('#modalTitle').text(titulo);
          modal.find('#modalBody').html(respuesta);

          // PASO 1: Remover 'hidden' y a帽adir 'flex' para que sea visible (pero con opacidad 0 y escala 95)
          // *El opacity-0 ya est谩 en el HTML por defecto*
          modal.removeClass('hidden').addClass('flex');
          
          // PASO 2: Iniciar la transici贸n (remover las clases de estado inicial)
          setTimeout(() => {
            modal.removeClass('opacity-0');       // Fondo: 0 -> 0.5 (animado)
            modalContent.removeClass('scale-95'); // Contenido: 0.95 -> 1 (animado)
          }, 10);
        },
        error: function() { alert('Error al cargar el formulario.'); }
      });
    }

    $('#closeModalBtn').on('click', cerrarModalAjax);
    
    function cerrarModalAjax() {
      const modal = $('#tailwindModal');
      const modalContent = $('#modalContent');

      // 1. Iniciar la transici贸n de cierre (a帽adir clases de estado final)
      modal.addClass('opacity-0');
      modalContent.addClass('scale-95');

      // 2. Esperar a que la transici贸n termine (300ms) antes de ocultar el modal
      setTimeout(() => {
          // Ocultar completamente y limpiar el contenido
          modal.addClass('hidden').removeClass('flex');
          modalContent.removeClass('scale-95'); // Limpiar para el siguiente open
          modal.find('#modalBody').empty();

          //  Recargar tabla del m贸dulo espec铆fico
          recargarTabla('#tablaClientes'); 
          recargarTabla('#tablaEmpleados'); 
          recargarTabla('#tablaHorarios');
          recargarTabla('#tablaTurnos');
          recargarTabla('#tablaCajas');
          recargarTabla('#tablaMetodos');
          recargarTabla('#tablaVentas');
          recargarTabla('#tablaProductos');
          recargarTabla('#tarjetasProductos');
          recargarTabla('#tablaServicios');
          recargarTabla('#inicio-container'); 
      }, 300); // **El tiempo debe coincidir con `duration-300`**
      }
    function recargarTabla(divSelector) {
      const div = $(divSelector);
      const url = div.data('url'); // URL donde se genera la tabla
      if (!url) return;

      $.ajax({
          url: url,
          method: 'GET',
          success: function(html) {
              div.html(html);
          },
          error: function(err) {
              console.error('Error recargando tabla:', err);
          }
      });
    }

    $(document).on('submit', '.ajax-form', function(e) {
      e.preventDefault();
      const form = $(this);

      $.ajax({
        url: form.attr('action'),
        method: form.attr('method'),
        data: form.serialize(),
        success: function(data) {
          if (data.success) {
            cerrarModalAjax();
            // 2. Mostramos la alerta si hay mensaje, sino una por defecto
            if (data.message) {
              showAlert('success', data.message);
            } else {
              showAlert('success', 'Operaci贸n exitosa');
            }
          } 
          else if (data.next_url) {
            // 猬锔猬锔 MOSTRAR ALERTA ANTES DE CAMBIAR EL MODAL
            showAlert('success', 'Operaci贸n exitosa');
            abrirModalAjax(data.next_url, 'Registrar Pago');
          } 
          else {
            $('#modalBody').html(data);
            showAlert('error', 'Verifica los datos ingresados');
          }
        },
        error: function(xhr) { 
          // Si la vista devolvi贸 JSON (errores personalizados)
          if (xhr.responseJSON && xhr.responseJSON.message) {
              showAlert('error', xhr.responseJSON.message);
          }
          else {
              // Error general (HTML con errores de formulario)
              $('#modalBody').html(xhr.responseText);
              showAlert('error', 'Revisa los errores del formulario');
          }
         }
      });
    });

    $(document).on('click', '.btnAbrirCaja', function() {
      const url = $(this).data('url');
      $.ajax({
        url: url,
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function(respuesta) {
            // Aqu铆 sabemos que es JSON con html
            $('#tailwindModal #modalTitle').text('Abrir Caja');
            $('#tailwindModal #modalBody').html(respuesta.html);
            $('#tailwindModal').removeClass('hidden').addClass('flex');
        },
        error: function() { alert('Error al cargar el modal de apertura de caja.'); }
      });
    });

    $(document).on('click', '.btnCerrarCaja', function() {
        const url = $(this).data('url');
        $.ajax({
            url: url,
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            success: function(respuesta) {
                $('#tailwindModal #modalTitle').text('Cerrar Caja');
                $('#tailwindModal #modalBody').html(respuesta.html);
                $('#tailwindModal').removeClass('hidden').addClass('flex');
            },
            error: function() { alert('Error al cargar el modal de cierre de caja.'); }
        });
    });

    $(document).on('submit', '.ajax-form-prod', function(e) {
      e.preventDefault();

      const form = $(this)[0];  // referencia al formulario nativo (no jQuery)
      const formData = new FormData(form);  // recoge todos los campos, incluido el archivo

      $.ajax({
        url: $(form).attr('action'),
        method: $(form).attr('method'),
        data: formData,
        processData: false,   // 锔 necesario para FormData
        contentType: false,   // 锔 necesario para FormData
        success: function(data) {
          cerrarModalAjax();
          // Verificamos si data es un objeto JSON con mensaje (como hicimos en las views)
          if (data && data.message) {
              showAlert('success', data.message);
          } else {
              // Fallback por si la vista no devuelve mensaje
              showAlert('success', 'Producto guardado correctamente');
          }
        },
        error: function(xhr) {
          $('#modalBody').html(xhr.responseText);
          // Lanzamos la alerta flotante
          showAlert('error', 'No se pudo guardar el producto. Revisa los errores.');
        }
      });
    });

    $(document).on('submit', '.ajax-form-emp', function(e) {
      e.preventDefault();

      const form = $(this)[0];  
      const formData = new FormData(form);  // incluye archivos s铆 o s铆

      $.ajax({
          url: $(form).attr('action'),
          method: $(form).attr('method'),
          data: formData,
          processData: false,   // necesario para archivos
          contentType: false,   // necesario para archivos
          success: function(data) {
              cerrarModalAjax();  // tu funci贸n para cerrar modal + refrescar tablas
              // 2. Verificamos si Django envi贸 un mensaje (JSON)
              if (data.message) {
                  showAlert('success', data.message);
              } else {
                  // Mensaje por defecto si tu vista no devolvi贸 JSON
                  showAlert('success', 'Operaci贸n realizada con 茅xito');
              }
          },
          error: function(xhr) {
              // si hay errores de validaci贸n, los muestra en el modal
              $('#modalBody').html(xhr.responseText);
              // 3. Agregamos alerta visual de error
              showAlert('error', 'Revisa los errores en el formulario')
          }
        });
    });

    $(document).on('click', '#home', function(e) {
        e.preventDefault();
        const url = $(this).data('url');
        cargarContenido(url);
    });

    function cargarContenido(url) {
        $.ajax({
            url: url,
            method: 'GET',
            success: function(respuesta) {
                $('#content-area').html(respuesta);
            },
            error: function() {
                alert('Error al cargar el contenido.');
            }
        });
    }
    // cargar vista Home por defecto al abrir el dash
    window.addEventListener("DOMContentLoaded", function() {
        const urlHome = "{% url 'home' %}";
        cargarContenido(urlHome, "Home", "fa-house");
    });

    function showAlert(type, message) {
        const container = document.getElementById("alert-container");

        // Definimos colores e iconos para cada tipo
        const config = {
            success: {
                bg: "bg-green-500",
                icon: `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            },
            error: {
                bg: "bg-red-500",
                icon: `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            },
            warning: {
                bg: "bg-yellow-500",
                icon: `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`
            },
            info: {
                bg: "bg-blue-500",
                icon: `<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            }
        };

        const style = config[type] || config.info;

        // Crear el elemento
        const alert = document.createElement("div");
        
        // Clases bases + Animaci贸n de entrada (Translate y Opacity)
        alert.className = `${style.bg} text-white px-4 py-3 rounded-lg shadow-lg flex items-center transform transition-all duration-500 translate-x-full opacity-0 pointer-events-auto`;
        
        alert.innerHTML = `${style.icon} <span class="font-medium">${message}</span>`;

        container.appendChild(alert);

        // Forzar un reflow para que la animaci贸n de entrada funcione
        setTimeout(() => {
            alert.classList.remove("translate-x-full", "opacity-0");
        }, 10);

        // Remover despu茅s de 3.5 segundos
        setTimeout(() => {
            // Animaci贸n de salida
            alert.classList.add("opacity-0", "translate-x-full");
            
            // Eliminar del DOM cuando termine la animaci贸n css (500ms)
            setTimeout(() => {
                alert.remove();
            }, 500);
        }, 3500);
    }
  </script>

  {% block extra_js %}
  <!-- Aqu铆 cargan scripts espec铆ficos de cada vista -->
  {% endblock %}
</body>
</html>
