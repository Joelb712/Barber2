{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{% block title %}Dashboard{% endblock %}</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

    <!-- Tu CSS -->
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    
    {% block extra_head %}{% endblock %}
</head>
<body class="antialiased">

  <!-- Overlay mobile -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <!-- Sidebar -->
  <nav id="sidebar" class="" aria-label="Sidebar">
    <div class="sidebar-header">
      <div class="logo-img">
        <img src="{% static 'imgs/logofede.png' %}" alt="Logo" class="w-6 h-6 object-cover">
      </div>
      <div class="logo-text">
        <div>FEDE BARBERSHOP</div>
        <div style="font-size:10px; opacity:.8">Sistema de Gestión</div>
      </div>
    </div>

    <ul class="sidebar-menu">
      <!-- MANTENGO data-name/data-icon para breadcrumb y compatibilidad -->
      <li class="menu-item">
        <a href="#" class="menu-link active" data-name="Inicio" data-icon="fa-house">
          <i class="fas fa-house"></i><span class="menu-text">Inicio</span>
        </a>
      </li>

      <li class="menu-item">
        <!-- CAMBIO: uso href con tu url Django (igual que tenías) -->
        <a href="{% url 'lista_empleados' %}" class="menu-link" data-name="Empleados" data-icon="fa-users">
          <i class="fas fa-users"></i><span class="menu-text">Empleados</span>
        </a>
      </li>

      <li class="menu-item">
        <a href="{% url 'lista_clientes' %}" class="menu-link" data-name="Clientes" data-icon="fa-user">
          <i class="fas fa-user"></i><span class="menu-text">Clientes</span>
        </a>
      </li>

      <li class="menu-item">
        <a href="{% url 'lista_ventas' %}" class="menu-link" data-name="Ventas" data-icon="fa-dollar-sign">
          <i class="fas fa-dollar-sign"></i><span class="menu-text">Ventas</span>
        </a>
      </li>

      <!-- Turnos (submenu) - uso button para evitar que el click cargue AJAX -->
      <li class="menu-item">
        <button class="menu-link" type="button" onclick="toggleSubmenu(this)">
          <i class="fas fa-calendar-check"></i>
          <span class="menu-text">Turnos</span>
          <i class="fas fa-chevron-down menu-arrow"></i>
        </button>
        <ul class="submenu">
          <li><a href="{% url 'lista_horarios' %}" class="submenu-link" data-nombre="Horarios" data-icono="fa-clock">Horarios</a></li>
          <li><a href="{% url 'turnos' %}" class="submenu-link" data-nombre="Turnos" data-icono="fa-calendar-check">Turnos</a></li>
          <li><a href="#" class="submenu-link">Gestionar días</a></li>
        </ul>
      </li>

      <!-- Cajas - submenu -->
      <li class="menu-item">
        <button class="menu-link" type="button" onclick="toggleSubmenu(this)">
          <i class="fas fa-cash-register"></i>
          <span class="menu-text">Cajas</span>
          <i class="fas fa-chevron-down menu-arrow"></i>
        </button>
        <ul class="submenu">
          <li><a href="{% url 'vista' %}" class="submenu-link" data-nombre="Cajas" data-icono="fa-cash-register">Ver Cajas</a></li>
          <li><a href="#" class="submenu-link">Métodos de Pago</a></li>
        </ul>
      </li>

      <!-- Catalogo -->
      <li class="menu-item">
        <button class="menu-link" type="button" onclick="toggleSubmenu(this)">
          <i class="fas fa-archive"></i>
          <span class="menu-text">Catálogo</span>
          <i class="fas fa-chevron-down menu-arrow"></i>
        </button>
        <ul class="submenu">
          <li><a href="{% url 'lista_productos' %}" class="submenu-link" data-nombre="Productos" data-icono="fa-box">Productos</a></li>
          <li><a href="{% url 'lista_servicios' %}" class="submenu-link" data-nombre="Servicios" data-icono="fa-scissors">Servicios</a></li>
        </ul>
      </li>

      <!-- Informes -->
      <li class="menu-item">
        <button class="menu-link" type="button" onclick="toggleSubmenu(this)">
          <i class="fas fa-chart-bar"></i>
          <span class="menu-text">Informes/Estadísticas</span>
          <i class="fas fa-chevron-down menu-arrow"></i>
        </button>
        <ul class="submenu">
          <li><a href="#" class="submenu-link">Reportes generales</a></li>
          <li><a href="#" class="submenu-link">Estadísticas</a></li>
        </ul>
      </li>

      <!-- Ayuda -->
      <li class="menu-item">
        <button class="menu-link" type="button" onclick="toggleSubmenu(this)">
          <i class="fas fa-question-circle"></i>
          <span class="menu-text">Ayuda</span>
          <i class="fas fa-chevron-down menu-arrow"></i>
        </button>
        <ul class="submenu">
          <li><a href="#" class="submenu-link">Manual de usuario</a></li>
          <li><a href="#" class="submenu-link">Soporte técnico</a></li>
          <li><a href="#" class="submenu-link">Contacto</a></li>
        </ul>
      </li>
    </ul>
  </nav>

  <!-- Main -->
  <main id="mainContent" class="min-h-screen bg-neutral-900">
    <!-- Top Navigation -->
    <div class="top-nav flex items-center justify-between px-4 py-3 ">
      <div class="flex items-center gap-3">
        <!-- CAMBIO: único botón para mobile (abre overlay) y desktop (colapsa) según width -->
        <button class="menu-toggle text-yellow-400  rounded" id="btnToggleSidebar" aria-label="toggle sidebar">
          <i class="fas fa-bars"></i>
        </button>

        <nav aria-label="breadcrumb" class="text-sm text-yellow-400 flex items-center gap-2">
          <a href="#"><i id="breadcrumb-icon"></i></a>
          <span id="breadcrumb-text" class="font-medium">Inicio</span>
        </nav>
      </div>

      <div class="nav-right flex items-center gap-3">
        <div class="user-info text-sm text-gray-50">
          <span>USUARIO</span>
          <div class="inline-flex items-center justify-center bg-white text-indigo-600 rounded-full w-8 h-8 ml-2 font-bold">US</div>
        </div>
      </div>
    </div>

    <div id="content-area" class="p-4 bg-neutral-900">
      {% block content %}
      <!-- Contenido AJAX -->
      {% endblock %}
    </div>
  </main>
  <!-- Modal genérico (fuera del content-area, persistente) -->
    <div id="tailwindModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h3 id="modalTitle" class="text-lg font-semibold text-gray-800">Formulario</h3>
        <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800">
            <i class="fas fa-times"></i>
        </button>
        </div>
        <div class="flex-1 overflow-hidden">
        <iframe id="modalIframe" src="" frameborder="0" class="w-full h-full min-h-[500px]"></iframe>
        </div>
    </div>
    </div>


  <!-- CAMBIO: scripts JS (todo en el mismo archivo para debug) -->
  <script>
    // Referencias
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const overlay = document.getElementById('overlay');
    const btnToggle = document.getElementById('btnToggleSidebar');

    // ========================
    // Utility: actualizar margen del main
    // ========================
    function updateMain() {
      if (window.innerWidth <= 768) {
        mainContent.style.marginLeft = '0';
        return;
      }
      if (sidebar.classList.contains('collapsed')) {
        mainContent.style.marginLeft = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-collapsed-w') || '70px';
      } else {
        mainContent.style.marginLeft = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-w') || '280px';
      }
    }

    // ========================
    // Toggle principal (mobile open / desktop collapse)
    // ========================
    btnToggle.addEventListener('click', function() {
      if (window.innerWidth <= 768) {
        // mobile: open/close sidebar overlay
        const opened = sidebar.classList.toggle('show');
        overlay.classList.toggle('show', opened);
        document.body.style.overflow = opened ? 'hidden' : '';
      } else {
        // desktop: collapse / expand
        sidebar.classList.toggle('collapsed');
        // CAMBIO: al colapsar cierro submenus para evitar "restos" visibles
        if (sidebar.classList.contains('collapsed')) closeAllSubmenus();
        updateMain();
      }
    });

    // overlay click close mobile sidebar
    overlay.addEventListener('click', () => {
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
      document.body.style.overflow = '';
    });

    // on resize: limpiar estados mobile/desktop y forzar recálculo
    function onResize() {
      if (window.innerWidth > 768) {
        sidebar.classList.remove('show');
        overlay.classList.remove('show');
        document.body.style.overflow = '';
      }
      updateMain();
    }
    window.addEventListener('resize', onResize);

    // ========================
    // Submenus robustos (abren/cerran sin quedarse pegados)
    // ========================
    function toggleSubmenu(button) {
      const li = button.parentElement;
      const submenu = li.querySelector('.submenu');
      if (!submenu) return;

      // UX: si sidebar colapsado en desktop no abrir submenu
      if (sidebar.classList.contains('collapsed') && window.innerWidth > 768) {
        return;
      }

      const isOpen = li.classList.contains('expanded');

      // cerrar otros submenus
      document.querySelectorAll('.menu-item.expanded').forEach(other => {
        if (other !== li) closeSubmenu(other);
      });

      if (isOpen) closeSubmenu(li);
      else openSubmenu(li);
    }

    function openSubmenu(li) {
      const submenu = li.querySelector('.submenu');
      if (!submenu) return;
      // show block para calcular scrollHeight
      submenu.style.display = 'block';
      const h = submenu.scrollHeight;
      submenu.style.maxHeight = '0px';
      requestAnimationFrame(() => { submenu.style.maxHeight = h + 'px'; });
      li.classList.add('expanded');
      // limpiar inline after transition
      submenu.addEventListener('transitionend', function handler() {
        if (li.classList.contains('expanded')) submenu.style.maxHeight = 'none';
        submenu.removeEventListener('transitionend', handler);
      });
    }

    function closeSubmenu(li) {
      const submenu = li.querySelector('.submenu');
      if (!submenu) return;
      // if maxHeight none => set to current height to animate
      if (getComputedStyle(submenu).maxHeight === 'none') {
        submenu.style.maxHeight = submenu.scrollHeight + 'px';
      }
      requestAnimationFrame(() => { submenu.style.maxHeight = '0px'; });
      li.classList.remove('expanded');
      submenu.addEventListener('transitionend', function handler() {
        // limpiar
        submenu.style.display = '';
        submenu.style.maxHeight = '';
        submenu.removeEventListener('transitionend', handler);
      });
    }

    function closeAllSubmenus() {
      document.querySelectorAll('.menu-item.expanded').forEach(closeSubmenu);
    }

    // ========================
    // Manejo visual de links (active) y breadcrumb
    // ========================
    function updateBreadcrumb(name, iconClass) {
      const iconEl = document.getElementById('breadcrumb-icon');
      const textEl = document.getElementById('breadcrumb-text');
      if (iconEl && textEl) {
        iconEl.innerHTML = '<i class="fas ' + iconClass + '"></i>';
        textEl.textContent = name;
      }
    }

    // activar links del menu principal (excluyendo botones de submenu)
    document.querySelectorAll('.menu-link').forEach(link => {
      // Si el link es un button (submenu toggle) lo dejamos (tiene onclick)
      if (link.tagName.toLowerCase() === 'button') return;
      link.addEventListener('click', function(e) {
        // Evitar navegación por defecto si href="#" o manejo AJAX
        // e.preventDefault(); // NO prevenir si es una url real a cargar via AJAX - lo maneja cargarContenido
        // visual active
        document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');

        // Actualizar breadcrumb (si data-name/data-icon están presentes)
        const name = this.dataset.name || this.querySelector('.menu-text')?.textContent?.trim() || 'Inicio';
        const icon = this.dataset.icon || 'fa-house';
        updateBreadcrumb(name, icon);
      });
    });

    // submenu-links (estas van a llamar a AJAX)
    document.querySelectorAll('.submenu-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        // visual
        document.querySelectorAll('.submenu-link').forEach(s => s.classList.remove('active'));
        this.classList.add('active');

        // cargar por AJAX si tiene href != '#'
        const url = this.getAttribute('href');
        const nombre = this.dataset.nombre || this.textContent.trim();
        const icono = this.dataset.icono || 'fa-folder';

        if (url && url !== '#') {
          cargarContenido(url, nombre, icono);
        }
        // cerrar sidebar en mobile
        if (window.innerWidth <= 768) {
          sidebar.classList.remove('show');
          overlay.classList.remove('show');
          document.body.style.overflow = '';
        }
      });
    });

    // ========================
    // DataTables init (igual que antes)
    // ========================
    $(document).ready(function() {
      // Inicializa TODAS las tablas con DataTables
      // CAMBIO: mantuve tu configuración original de DataTables y botones
      $('table').DataTable({
        responsive: true,
        autoWidth:false,
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        dom: 'Bfrtip',
        buttons: ['excel', 'pdf', 'print']
      });
    });

    // Cerrar modal desde botón o fondo
        document.getElementById('closeModalBtn')?.addEventListener('click', function() {
            const modal = document.getElementById('tailwindModal');
            const iframe = document.getElementById('modalIframe');
            if (modal) modal.classList.add('hidden');
            if (iframe) iframe.src = '';
        });

        document.getElementById('tailwindModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
            e.target.classList.add('hidden');
            document.getElementById('modalIframe').src = '';
            }
        });

    // Escuchar mensajes del iframe para cerrar el modal (global)
    window.addEventListener('message', function(event) {
    if (event.data && event.data.action === 'closeBootbox') {
        const modal = document.getElementById('tailwindModal');
        const iframe = document.getElementById('modalIframe');
        if (modal) modal.classList.add('hidden');
        if (iframe) iframe.src = '';

        // Recargar la vista actual (por ejemplo, lista_empleados)
        const currentUrl = window.location.pathname;
        if (currentUrl.includes('/empleados/')) {
          cargarContenido("{% url 'lista_empleados' %}", "Empleados", "fa-users");
        }
        else if (currentUrl.includes('/clientes/')) {
          cargarContenido("{% url 'lista_clientes' %}", "Clientes", "fa-user");
        }
        else if (currentUrl.includes('/productos/')) {
          cargarContenido("{% url 'lista_productos' %}", "Productos", "fa-box");
        }
        else if (currentUrl.includes('/servicios/')) {
          cargarContenido("{% url 'lista_servicios' %}", "Servicios", "fa-scissors");
        }
        else if (currentUrl.includes('/turnos/')) {
          cargarContenido("{% url 'turnos' %}", "Turnos", "fa-calendar-check");
        }
        else if (currentUrl.includes('ventas')) {
          cargarContenido("{% url 'lista_ventas' %}", "Ventas", "fa-cash-register");
        }
        // Puedes extender esto para otras secciones si lo necesitas
    }
    });

    window.addEventListener('message', function(event) {
      if (event.data && event.data.action === 'showMessage') {
        const { message, type } = event.data;

        // Mostrar el mensaje (puede ser un alert o algo más bonito)
        if (type === 'success') {
          alert("✅ " + message);
        } else if (type === 'error') {
          alert("❌ " + message);
        } else {
          alert(message);
        }

        // Esperar un poco y cerrar el modal
        setTimeout(() => {
          const modal = document.getElementById('tailwindModal');
          const iframe = document.getElementById('modalIframe');
          if (modal) modal.classList.add('hidden');
          if (iframe) iframe.src = '';

          // Recargar la vista actual (como ya hacés)
          const currentUrl = window.location.pathname;
          if (currentUrl.includes('/empleados/')) {
            cargarContenido("{% url 'lista_empleados' %}", "Empleados", "fa-users");
          }
          else if (currentUrl.includes('/clientes/')) {
            cargarContenido("{% url 'lista_clientes' %}", "Clientes", "fa-user");
          }
          else if (currentUrl.includes('/productos/')) {
            cargarContenido("{% url 'lista_productos' %}", "Productos", "fa-box");
          }
          else if (currentUrl.includes('/servicios/')) {
            cargarContenido("{% url 'lista_servicios' %}", "Servicios", "fa-scissors");
          }
          else if (currentUrl.includes('/turnos/')) {
            cargarContenido("{% url 'turnos' %}", "Turnos", "fa-calendar-check");
          }
          else if (currentUrl.includes('ventas')) {
            cargarContenido("{% url 'lista_ventas' %}", "Ventas", "fa-cash-register");
          }
        }, 800);
      }
    });

    // ========================
    // AJAX loader (cargarContenido) casi idéntico al original
    // ========================
    function cargarContenido(url, nombre = "", icono = "fa-folder") {
      $.ajax({
        url: url,
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        xhrFields: { withCredentials: true },
        success: function(respuesta, status, jqXHR) {
          // Si devolvió página completa, redirigimos
          if (typeof respuesta === 'string' && (respuesta.includes('<html') || respuesta.includes('<head'))) {
            window.location.href = url;
            return;
          }

          // Si devolvió login (form de login) -> redirigir a login
          if (respuesta.includes('name="username"') && respuesta.includes('name="password"')) {
            window.location.href = "{% url 'login' %}";
            return;
          }

          // Caso normal: inyectar contenido
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = respuesta;

            // 👇 Ejecutar scripts manualmente
            contentArea.querySelectorAll('script').forEach(oldScript => {
            const newScript = document.createElement('script');
            if (oldScript.src) {
                newScript.src = oldScript.src;
            } else {
                newScript.textContent = oldScript.textContent;
            }
            oldScript.parentNode.replaceChild(newScript, oldScript);
            });

          // actualizamos breadcrumb con lo que pasamos
          if (nombre) updateBreadcrumb(nombre, icono);
        },
        error: function(error) {
          console.error('Error al cargar contenido:', error);
          // Opcional mostrar mensaje al usuario
        }
      });
    }

    // también habilito que al clickear links del menú principal que tienen href (no '#'),
    // use la misma lógica AJAX (como en tu plantilla original).
    document.querySelectorAll('.menu-link[href]').forEach(link => {
      // saltar botones de submenu
      if (link.tagName.toLowerCase() === 'button') return;
      link.addEventListener('click', function(e) {
        const url = link.getAttribute('href');
        // si url existe y no es '#', usamos AJAX
        if (url && url !== '#') {
          e.preventDefault();
          const nombre = link.dataset.name || link.querySelector('.menu-text')?.textContent?.trim() || "Inicio";
          const icono = link.dataset.icon || 'fa-house';
          cargarContenido(url, nombre, icono);

          // en mobile cerramos la sidebar
          if (window.innerWidth <= 768) {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
          }
        }
      });
    });

    // Limpieza inicial al cargar
    window.addEventListener('DOMContentLoaded', function() {
      // Asegurar estado limpio
      closeAllSubmenus();
      updateMain();
    });
  </script>

  {% block extra_js %}
  <!-- Aquí cargan scripts específicos de cada vista -->
  {% endblock %}
</body>
</html>
