{% load static %}
<div class="card">
<div id="inicio-container" class="p-6 space-y-6" data-url="{% url 'home' %}">

  <!-- Secci칩n general -->
  <div class="text-center">
    <h2 class="text-2xl font-bold text-yellow-400">춰Bienvenido {{ empleado.user.first_name }}!</h2>
  </div>

  <!-- Secci칩n Barbero -->
  {% if especialidad == 'Barbero' %}
    <div class="bg-neutral-900 text-gray-200 antialiased">
        <div class="max-w-5xl mx-auto px-4 py-6">
            <!-- Encabezado -->
            <header class="mb-6 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-yellow-400">Mi Agenda</h1>
                <p class="text-neutral-400 text-sm mt-1">Turnos y pr칩ximos servicios</p>
            </div>
            </header>

            <!-- Resumen r치pido de estado -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-neutral-800 rounded-lg p-4 flex items-center justify-between">
                <div>
                <p class="text-neutral-400 text-sm">Turnos completados</p>
                <h2 class="text-2xl font-bold text-green-400">{{completados}}</h2>
                </div>
                <i class="fa-solid fa-check-circle text-green-400 text-2xl"></i>
            </div>

            <div class="bg-neutral-800 rounded-lg p-4 flex items-center justify-between">
                <div>
                <p class="text-neutral-400 text-sm">Turnos pendientes</p>
                <h2 class="text-2xl font-bold text-yellow-400">{{pendientes}}</h2>
                </div>
                <i class="fa-solid fa-clock text-yellow-400 text-2xl"></i>
            </div>

            <div class="bg-neutral-800 rounded-lg p-4 flex items-center justify-between">
                <div>
                <p class="text-neutral-400 text-sm">Cancelados</p>
                <h2 class="text-2xl font-bold text-red-400">{{cancelados}}</h2>
                </div>
                <i class="fa-solid fa-xmark-circle text-red-400 text-2xl"></i>
            </div>
            </section>

            <!-- Turnos del d칤a -->
            <section class="bg-neutral-800 p-4 rounded-lg mb-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-yellow-400">Turnos de Hoy</h3>
                <span class="text-xs text-neutral-400">{{hoy}}</span>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-gray-300">
                <thead class="bg-neutral-700">
                    <tr>
                    <th class="px-3 py-2 text-left">Hora</th>
                    <th class="px-3 py-2 text-left">Cliente</th>
                    <th class="px-3 py-2 text-left">Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for turno in turnoshoy %}
                        <tr class="border-b border-neutral-800">
                        <td class="px-3 py-2">{{ turno.horario.hora_inicio|time:"H:i" }}</td>
                        <td class="px-3 py-2">{{ turno.cliente }}</td>
                        <td class="px-3 py-2">{{ turno.estado.nombre }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="3">No hay turnos para hoy</td>
                        </tr>
                    {% endfor %}
                </tbody>
                </table>
            </div>
            </section>

            <!-- Pr칩ximos turnos -->
            <section class="bg-neutral-800 p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-3 text-yellow-400">Pr칩ximos Turnos (Semana)</h3>
            <ul class="divide-y divide-neutral-700 text-sm max-h-72 overflow-y-auto">
                {% for semana in turnos_semana %}
                <li class="py-3 flex justify-between">
                <span>{{ semana.fecha|date:"D" }}, {{ semana.fecha|date:"d/m" }}  -  {{ semana.horario.hora_inicio|time:"H:i" }}</span>
                <span class="text-neutral-300">{{ semana.cliente.first_name }} {{ semana.cliente.last_name }}</span>
                </li>
                {% endfor%}
            </ul>
            </section>
        </div>
    </div>
  {% endif %}

  <!-- Secci칩n Recepcionista -->
  {% if especialidad == 'Recepcionista' %}
  <div class="bg-neutral-900 text-gray-200 antialiased">
    <div class="max-w-6xl mx-auto px-4 py-6">
        <!-- Encabezado -->
        <header class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
            <h1 class="text-3xl font-bold text-yellow-400">Panel de Recepci칩n</h1>
            <p class="text-neutral-400 text-sm mt-1">Gesti칩n diaria y control de caja</p>
        </div>
        </header>

        <!-- Fila 1: Turnos del d칤a + Accesos r치pidos -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <!-- Caja actual -->
        <div class="bg-neutral-800 p-4 rounded-lg md:col-span-2">
            <h3 class="text-lg font-semibold mb-3 text-yellow-400">Caja Actual</h3>

            <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="p-3 bg-neutral-900 rounded-lg text-center">
                <p class="text-neutral-400 text-sm mb-1">Efectivo</p>
                <h2 class="text-2xl font-bold text-green-400">$ {{ efectivo|floatformat:2 }}</h2>
            </div>
            <div class="p-3 bg-neutral-900 rounded-lg text-center">
                <p class="text-neutral-400 text-sm mb-1">Tarjeta</p>
                <h2 class="text-2xl font-bold text-blue-400">$ {{ tarjeta|floatformat:2 }}</h2>
            </div>
            <div class="p-3 bg-neutral-900 rounded-lg text-center">
                <p class="text-neutral-400 text-sm mb-1">Otros</p>
                <h2 class="text-2xl font-bold text-yellow-400">$ {{ otros|floatformat:2 }}</h2>
            </div>
            </div>

            <div class="text-right text-sm text-neutral-400">
            Total en caja: <span class="text-gray-100 font-semibold">$ {{ total_caja|floatformat:2 }}</span>
            </div>
        </div>

        <!-- Accesos r치pidos -->
        <div class="bg-neutral-800 p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-4 text-yellow-400">Accesos R치pidos</h3>
            <div class="flex flex-col gap-3">
            <button data-url="{% url 'dar_turno' %}" data-titulo="Nuevo Turno" class="btn-ajax-form bg-yellow-500 hover:bg-yellow-600 text-neutral-900 font-semibold py-2 rounded">
                <i class="fa fa-calendar-check mr-2"></i>Nuevo Turno
            </button>
            <button data-url="{% url 'formcli' %}" data-titulo="Nuevo Cliente" class="btn-ajax-form bg-neutral-700 hover:bg-neutral-600 text-gray-200 font-semibold py-2 rounded">
                <i class="fa fa-user mr-2"></i>Nuevo Cliente
            </button>
            <button data-url="{% url 'crear_venta' %}" data-titulo="Nuevo Venta" class="btn-ajax-form bg-yellow-500 hover:bg-yellow-600 text-neutral-900 font-semibold py-2 rounded">
                <i class="fa fa-cash-register mr-2"></i>Nueva Venta
            </button>
            </div>
        </div>
        </section>

        <!-- Fila 2: Caja actual + 칔ltimos cobros -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="bg-neutral-800 p-4 rounded-lg md:col-span-2">
            <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold text-yellow-400">Turnos del D칤a</h3>
            <span class="text-xs text-neutral-400">{{hoy}}</span>
            </div>

            <div id="tablaturnosrecep" class="overflow-x-auto">
                <table class="min-w-full text-sm text-gray-300">
                    <thead class="bg-neutral-700">
                        <tr>
                            <th class="px-3 py-2 text-left">Hora</th>
                            <th class="px-3 py-2 text-left">Cliente</th>
                            <th class="px-3 py-2 text-left">Peluquero</th>
                            <th class="px-3 py-2 text-left">Estado</th>
                            <th class="px-3 py-2 text-left">Cobrar</th> <!-- Nueva columna -->
                        </tr>
                    </thead>
                    <tbody>
                        {% for turno in turnostodos %}
                        <tr class="border-b border-neutral-800">
                            <td class="px-3 py-2">{{ turno.horario.hora_inicio|time:"H:i" }}</td>
                            <td class="px-3 py-2">{{ turno.cliente }}</td>
                            <td class="px-3 py-2">{{ turno.empleado }}</td>
                            <td class="px-3 py-2">{{ turno.estado.nombre }}</td>
                            <td class="px-3 py-2">
                                {% if turno.estado.nombre == 'cancelado' %}
                                    <span class="text-gray-400 font-semibold">---</span>

                                {% elif not turno.pagado %}
                                    <button 
                                        class="btn-ajax-form bg-green-600 text-black py-1 px-3 rounded"
                                        data-url="{% url 'cobrar_turno' turno.id %}"
                                        data-titulo="Cobrar Turno">
                                        Cobrar
                                    </button>

                                {% else %}
                                    <span class="text-green-400 font-semibold">Pagado</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No hay turnos para hoy</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        </section>
    </div>
    </div>
  {% endif %}

  <!-- Secci칩n Gerente -->
  {% if especialidad == 'Gerente' %}
  <div class="bg-neutral-900 text-gray-200 antialiased">
    <div class="max-w-6xl mx-auto px-4 py-6">
        <!-- Encabezado -->
        <header class="mb-6">
        <h1 class="text-3xl font-bold text-yellow-400">Panel de Gerencia</h1>
        <p class="text-neutral-400 text-sm mt-1">Resumen general y turnos del d칤a</p>
        </header>

        <!-- Fila 1: KPIs -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <!-- Ventas del d칤a -->
        <div class="bg-neutral-800 p-4 rounded-lg flex items-center justify-between">
            <div>
            <p class="text-neutral-400 text-sm">Ventas del d칤a</p>
            <h2 class="text-3xl font-extrabold text-yellow-400">$ {{total_hoy}}</h2>
            </div>
            <i class="fa-solid fa-sack-dollar text-yellow-400 text-3xl"></i>
        </div>

        <!-- Servicios realizados -->
        <div class="bg-neutral-800 p-4 rounded-lg flex items-center justify-between">
            <div>
            <p class="text-neutral-400 text-sm">Servicios completados</p>
            <h2 class="text-3xl font-extrabold text-green-400">{{total_completados_hoy}}</h2>
            <p class="text-xs text-neutral-400 mt-1">Pendientes: {{total_pendientes_hoy}}</p>
            </div>
            <i class="fa-solid fa-scissors text-green-400 text-3xl"></i>
        </div>

        <!-- Caja actual -->
        <div class="bg-neutral-800 p-4 rounded-lg flex items-center justify-between">
            <div>
            <p class="text-neutral-400 text-sm">Caja actual</p>
            <h2 class="text-3xl font-extrabold text-blue-400">$ {{monto_total_caja}}</h2>
            <p class="text-xs text-neutral-400 mt-1">칔lt. mov.: +${{venta_mas_reciente_total}}</p>
            </div>
            <i class="fa-solid fa-cash-register text-blue-400 text-3xl"></i>
        </div>
        </section>

        <!-- Fila 2: Turnos pendientes -->
        <section class="bg-neutral-800 p-4 rounded-lg mb-6">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold text-yellow-400">Turnos Pendientes de Hoy</h3>
            <span class="text-xs text-neutral-400">Datos de ejemplo</span>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-gray-300">
            <thead class="bg-neutral-700">
                <tr>
                <th class="px-3 py-2 text-left">Hora</th>
                <th class="px-3 py-2 text-left">Cliente</th>
                <th class="px-3 py-2 text-left">Peluquero</th>
                <th class="px-3 py-2 text-left">Servicio</th>
                <th class="px-3 py-2 text-left">Estado</th>
                </tr>
            </thead>
            <tbody>
                <tr class="border-b border-neutral-800">
                <td class="px-3 py-2">09:00</td>
                <td class="px-3 py-2">Mart칤n L칩pez</td>
                <td class="px-3 py-2">Fede</td>
                <td class="px-3 py-2">Corte cl치sico</td>
                <td class="px-3 py-2 text-yellow-400">Pendiente</td>
                </tr>
                <tr class="border-b border-neutral-800">
                <td class="px-3 py-2">09:30</td>
                <td class="px-3 py-2">Carlos Ruiz</td>
                <td class="px-3 py-2">Lautaro</td>
                <td class="px-3 py-2">Corte + barba</td>
                <td class="px-3 py-2 text-yellow-400">Pendiente</td>
                </tr>
                <tr class="border-b border-neutral-800">
                <td class="px-3 py-2">10:15</td>
                <td class="px-3 py-2">Diego Ramos</td>
                <td class="px-3 py-2">Brisa</td>
                <td class="px-3 py-2">Color + corte</td>
                <td class="px-3 py-2 text-yellow-400">Pendiente</td>
                </tr>
                <tr class="border-b border-neutral-800">
                <td class="px-3 py-2">11:00</td>
                <td class="px-3 py-2">Luciano P칠rez</td>
                <td class="px-3 py-2">Mati</td>
                <td class="px-3 py-2">Barba</td>
                <td class="px-3 py-2 text-yellow-400">Pendiente</td>
                </tr>
                <tr>
                <td class="px-3 py-2">11:30</td>
                <td class="px-3 py-2">Santiago Ferreyra</td>
                <td class="px-3 py-2">Rami</td>
                <td class="px-3 py-2">Corte fade</td>
                <td class="px-3 py-2 text-yellow-400">Pendiente</td>
                </tr>
            </tbody>
            </table>
        </div>
        </section>
        <!--  GRAFICOS-->
        <section class="bg-neutral-800 p-4 rounded-lg mb-6">
            <div class="bg-neutral-800 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold text-yellow-400 mb-4">Ingresos de la Semana</h3>
                
                <div class="h-64">
                    <canvas id="chartIngresos" class="w-full h-full"></canvas>
                </div>
                
            </div>
        </section>
        <!-- 游 NUEVA SECCI칍N: GR츼FICO LINEAL DE INGRESOS DIARIOS -->
        <section class="bg-neutral-800 p-4 rounded-lg mb-6">
            <div class="bg-neutral-800 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold text-yellow-400 mb-4">Tendencia Diaria de Ingresos</h3>
                <!-- Contenedor del Gr치fico Lineal -->
                <div class="h-80 md:h-96"> 
                    <canvas id="chartLinealDiario" class="w-full h-full"></canvas>
                </div>
            </div>
        </section>
        <!--  NUEVA SECCI칍N: GR츼FICO DE BARRAS DE TURNOS -->
        <section class="bg-neutral-800 p-4 rounded-lg mb-6 shadow-xl">
            <h3 class="text-xl font-bold text-yellow-400 mb-4 border-b border-neutral-700 pb-2">
                An치lisis Semanal de Turnos (Completados vs. Cancelados)
            </h3>
            <!-- Contenedor del Gr치fico de Barras -->
            <div class="h-80 md:h-96"> 
                <canvas id="chartTurnosBarras" class="w-full h-full"></canvas>
            </div>
        </section>

        <!-- Fila 3: Ingresos y pagos -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Ingresos por empleado -->
        <div class="bg-neutral-800 p-4 rounded-lg lg:col-span-2">
            <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold text-yellow-400">Ingresos por empleado y Monto a pagar (hoy)</h3>
            <span class="text-xs text-neutral-400">Datos demo</span>
            </div>
            <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="bg-neutral-700 text-gray-200">
                <tr>
                    <th class="px-3 py-2 text-left">Empleado</th>
                    <th class="px-3 py-2 text-left">Servicios</th>
                    <th class="px-3 py-2 text-left">Ingresos</th>
                    <th class="px-3 py-2 text-left">A pagar</th>
                </tr>
                </thead>
                <tbody>
                <tr class="border-b border-neutral-800">
                    <td class="px-3 py-2">Fede</td>
                    <td class="px-3 py-2">22</td>
                    <td class="px-3 py-2 text-green-400">$ 38.500</td>
                    <td class="px-3 py-2 text-green-400">$ 1.750</td>
                </tr>
                <tr class="border-b border-neutral-800">
                    <td class="px-3 py-2">Lautaro</td>
                    <td class="px-3 py-2">18</td>
                    <td class="px-3 py-2 text-green-400">$ 30.200</td>
                    <td class="px-3 py-2 text-green-400">$ 1.678</td>
                </tr>
                <tr class="border-b border-neutral-800">
                    <td class="px-3 py-2">Brisa</td>
                    <td class="px-3 py-2">14</td>
                    <td class="px-3 py-2 text-green-400">$ 24.400</td>
                    <td class="px-3 py-2 text-green-400">$ 1.742</td>
                </tr>
                </tbody>
            </table>
            </div>
        </div>

        </section>
    </div>
    </div>
  {% endif %}

</div>

</div>

<script>

    // ----------------------------------------------------
    // GR츼FICO 1: TORTA (Ingresos Productos vs Servicios)
    // ----------------------------------------------------
    function iniciarGraficoIngresos() {
        const canvas = document.getElementById("chartIngresos");
        if (!canvas) {
            console.log("DEPURACI칍N: Canvas 'chartIngresos' no encontrado.");
            return;
        }
        
        const ctx = canvas.getContext("2d");
        const urlDatos = "{% url 'datos_torta' %}";
        
        fetch(urlDatos)
            .then(response => {
                if (!response.ok) throw new Error(`Error HTTP! Estado: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log("DEPURACI칍N: Datos Torta recibidos:", data);
                
                let ingresosServicios = data.ingresos_servicios || 0;
                let ingresosProductos = data.ingresos_productos || 0;
                const totalIngresos = ingresosServicios + ingresosProductos;
                
                if (totalIngresos === 0) {
                    ctx.font = "16px sans-serif";
                    ctx.fillStyle = "#A1A1AA"; 
                    ctx.textAlign = "center";
                    // Aseguramos que el texto se dibuje en el centro del contenedor (si no est치 estirado)
                    ctx.fillText("No hay datos de ingresos esta semana.", canvas.width / 2, canvas.height / 2);
                    return; 
                }

                if (window.graficoTorta) { window.graficoTorta.destroy(); }

                window.graficoTorta = new Chart(ctx, {
                    type: "pie",
                    data: {
                        labels: ["Servicios", "Productos"],
                        datasets: [{
                            data: [ingresosServicios, ingresosProductos],
                            backgroundColor: [
                                '#f59e0b', // Amarillo/Naranja 
                                '#3b82f6'  // Azul 
                            ], 
                            hoverOffset: 16
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: 10 },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: { color: '#e5e5e5' }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        const value = new Intl.NumberFormat('es-AR', {
                                            style: 'currency',
                                            currency: 'ARS',
                                            minimumFractionDigits: 0
                                        }).format(context.raw);
                                        return label + value;
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error("DEPURACI칍N: Error en el gr치fico de torta:", error);
            });
    }


    // ----------------------------------------------------
    // 游 GR츼FICO 2: LINEAL (Tendencia Diaria)
    // ----------------------------------------------------
    function iniciarGraficoLineal() {
        const canvas = document.getElementById("chartLinealDiario");
        if (!canvas) {
            console.log("DEPURACI칍N: Canvas 'chartLinealDiario' no encontrado.");
            return;
        }
        
        const ctx = canvas.getContext("2d");
        const urlDatos = "{% url 'datos_lineal' %}"; // Usamos la nueva URL
        
        fetch(urlDatos)
            .then(response => {
                if (!response.ok) throw new Error(`Error HTTP! Estado: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log("DEPURACI칍N: Datos Lineal recibidos:", data);
                
                const labels = data.labels; // Lun, Mar, Mi칠...
                const ingresosData = data.data; // [100, 200, 0, 0, ...]
                const totalIngresos = ingresosData.reduce((sum, current) => sum + current, 0);

                if (totalIngresos === 0) {
                    // Si el total es 0, dibujamos el mensaje en el canvas
                    ctx.font = "16px sans-serif";
                    ctx.fillStyle = "#A1A1AA"; 
                    ctx.textAlign = "center";
                    ctx.fillText("No hay ingresos registrados esta semana.", canvas.width / 2, canvas.height / 2);
                    return; 
                }

                if (window.graficoLineal) { window.graficoLineal.destroy(); }

                window.graficoLineal = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ingresos Diarios (ARS)',
                            data: ingresosData,
                            backgroundColor: 'rgba(245, 158, 11, 0.2)', // Fondo suave
                            borderColor: '#f59e0b', // L칤nea principal (Amarillo/Naranja)
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: true, // Rellenar debajo de la l칤nea
                            tension: 0.4 // Curva suave
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: 5 },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }, // L칤neas de grid tenues
                                ticks: {
                                    color: '#e5e5e5', // Color de los n칰meros del eje Y
                                    callback: function(value) {
                                        return '$' + new Intl.NumberFormat('es-AR').format(value); // Formato ARS
                                    }
                                }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#e5e5e5' } // Color de los d칤as
                            }
                        },
                        plugins: {
                            legend: {
                                display: false, // La etiqueta es clara en la l칤nea
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        const value = new Intl.NumberFormat('es-AR', {
                                            style: 'currency',
                                            currency: 'ARS',
                                            minimumFractionDigits: 0
                                        }).format(context.raw);
                                        return value;
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error("DEPURACI칍N: Error en el gr치fico lineal:", error);
            });
    }
    function iniciarGraficoTurnos() {
        const canvas = document.getElementById("chartTurnosBarras");
        if (!canvas) {
            console.warn("Canvas 'chartTurnosBarras' no encontrado. Aseg칰rese de que el ID est칠 en el HTML.");
            return;
        }
        
        const ctx = canvas.getContext("2d");
        // 丘멆잺 Aseg칰rate de que esta URL sea correcta. Si est치s en un template de Django, usa:
        // const urlDatos = "{% url 'datos_turnos' %}"; 
        // Si no est치s en un template, usa la URL directa:
        const urlDatos = "/datos-turnos/"; 
        
        fetch(urlDatos)
            .then(response => {
                if (!response.ok) throw new Error(`Error HTTP! Estado: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log("DEPURACI칍N: Datos Turnos recibidos:", data);
                
                const labels = data.labels; // Lun, Mar, Mi칠...
                const completadosData = data.completados || [];
                const canceladosData = data.cancelados || [];
                
                const totalTurnos = completadosData.reduce((sum, current) => sum + current, 0) +
                                    canceladosData.reduce((sum, current) => sum + current, 0);

                if (totalTurnos === 0) {
                    // Si no hay datos, muestra un mensaje en el canvas
                    ctx.font = "16px sans-serif";
                    ctx.fillStyle = "#A1A1AA"; 
                    ctx.textAlign = "center";
                    ctx.fillText("No hay turnos Completados o Cancelados esta semana.", canvas.width / 2, canvas.height / 2);
                    return; 
                }

                // Destruye la instancia anterior si existe (para refrescos)
                if (window.graficoTurnos) { window.graficoTurnos.destroy(); }

                window.graficoTurnos = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Completados',
                                data: completadosData,
                                backgroundColor: '#10b981', // Verde esmeralda
                                borderRadius: 6,
                            },
                            {
                                label: 'Cancelados',
                                data: canceladosData,
                                backgroundColor: '#ef4444', // Rojo
                                borderRadius: 6,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: 10 },
                        scales: {
                            x: {
                                stacked: false, // Barras agrupadas (una al lado de la otra)
                                grid: { display: false },
                                ticks: { color: '#e5e5e5' }
                            },
                            y: {
                                stacked: false,
                                beginAtZero: true,
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: {
                                    color: '#e5e5e5',
                                    precision: 0 
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: { color: '#e5e5e5' }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        return label + context.raw + ' turnos';
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error("Error al obtener datos del gr치fico de turnos:", error);
            });
    }
    
    // Llamamos a ambas funciones en la carga del DOM y directamente (para AJAX/HTMX)
    document.addEventListener("DOMContentLoaded", iniciarGraficoIngresos);
    document.addEventListener("DOMContentLoaded", iniciarGraficoLineal);
    document.addEventListener("DOMContentLoaded", iniciarGraficoTurnos);
    
    // Llamada directa como respaldo para carga din치mica
    iniciarGraficoIngresos();
    iniciarGraficoLineal();
    iniciarGraficoTurnos();

</script>