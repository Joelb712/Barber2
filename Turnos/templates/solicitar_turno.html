<!-- templates/turnos/solicitar_turno.html -->
{% extends 'dash.html' %}

{% block content %}
<h2>Solicitar Turno</h2>
<button class="btn btn-primary" id="btnSolicitarTurno">Solicitar Turno</button>

<!-- Modal -->
<div class="modal fade" id="modalTurno" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Solicitar Turno</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="accordion" id="accordionTurno">
          <!-- Paso 1: Servicios -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#step1">
                1. Selecciona tus servicios
              </button>
            </h2>
            <div id="step1" class="accordion-collapse collapse show">
              <div class="accordion-body">
                <div id="servicios-list"></div>
              </div>
            </div>
          </div>

          <!-- Paso 2: Barbero -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step2">
                2. Elige un barbero
              </button>
            </h2>
            <div id="step2" class="accordion-collapse collapse">
              <div class="accordion-body">
                <select id="selectBarbero" class="form-select">
                  <option value="">-- Selecciona --</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Paso 3: Fecha -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step3">
                3. Selecciona fecha
              </button>
            </h2>
            <div id="step3" class="accordion-collapse collapse">
              <div class="accordion-body">
                <input type="date" id="inputFecha" class="form-control" min="{{ fecha_minima }}">
              </div>
            </div>
          </div>

          <!-- Paso 4: Horario -->
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step4">
                4. Elige horario disponible
              </button>
            </h2>
            <div id="step4" class="accordion-collapse collapse">
              <div class="accordion-body">
                <div id="horarios-disponibles"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="btnConfirmarTurno">Confirmar Turno</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  let serviciosSeleccionados = [];
  
  document.getElementById('btnSolicitarTurno').addEventListener('click', () => {
    const modal = new bootstrap.Modal(document.getElementById('modalTurno'));
    modal.show();
    cargarServicios();
    cargarBarberos();
  });

  // Paso 1: Cargar servicios
  function cargarServicios() {
    fetch('{% url "get_servicios" %}')
      .then(r => r.json())
      .then(servicios => {
        const cont = document.getElementById('servicios-list');
        cont.innerHTML = servicios.map(s => `
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${s.id}" id="serv-${s.id}">
            <label class="form-check-label" for="serv-${s.id}">
              ${s.nombre} - $${s.precio} (${s.duracion} min)
            </label>
          </div>
        `).join('');
        
        // Re-vincular eventos
        servicios.forEach(s => {
          document.getElementById(`serv-${s.id}`).addEventListener('change', (e) => {
            if (e.target.checked) {
              serviciosSeleccionados.push(s.id);
            } else {
              serviciosSeleccionados = serviciosSeleccionados.filter(id => id !== s.id);
            }
          });
        });
      });
  }

  // Paso 2: Cargar barberos
  function cargarBarberos() {
    fetch('{% url "get_barberos" %}')
      .then(r => r.json())
      .then(barberos => {
        const sel = document.getElementById('selectBarbero');
        sel.innerHTML = '<option value="">-- Selecciona --</option>';
        barberos.forEach(b => {
          const opt = document.createElement('option');
          opt.value = b.id;
          opt.textContent = b.nombre;
          sel.appendChild(opt);
        });
      });
  }

  // Paso 3: Al cambiar fecha, cargar horarios
  document.getElementById('inputFecha').addEventListener('change', function() {
    const empleadoId = document.getElementById('selectBarbero').value;
    const fecha = this.value;
    if (empleadoId && fecha) {
      fetch(`{% url "get_horarios_disponibles" %}?empleado_id=${empleadoId}&fecha=${fecha}`)
        .then(r => r.json())
        .then(horarios => {
          const cont = document.getElementById('horarios-disponibles');
          if (horarios.length === 0) {
            cont.innerHTML = '<p class="text-warning">No hay horarios disponibles para esta fecha.</p>';
          } else {
            cont.innerHTML = horarios.map(h => `
              <button type="button" class="btn btn-outline-primary m-1 horario-btn" data-id="${h.id}">
                ${h.hora}
              </button>
            `).join('');
            
            // Vincular botones
            document.querySelectorAll('.horario-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                document.querySelectorAll('.horario-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
              });
            });
          }
        });
    }
  });

  // Paso 2: Al cambiar barbero, si ya hay fecha, recargar horarios
  document.getElementById('selectBarbero').addEventListener('change', function() {
    const fecha = document.getElementById('inputFecha').value;
    if (fecha) {
      document.getElementById('inputFecha').dispatchEvent(new Event('change'));
    }
  });

  // Confirmar turno
  document.getElementById('btnConfirmarTurno').addEventListener('click', function() {
    const empleadoId = document.getElementById('selectBarbero').value;
    const fecha = document.getElementById('inputFecha').value;
    const horarioBtn = document.querySelector('.horario-btn.active');
    
    if (!serviciosSeleccionados.length) {
      alert('Selecciona al menos un servicio');
      return;
    }
    if (!empleadoId) {
      alert('Selecciona un barbero');
      return;
    }
    if (!fecha) {
      alert('Selecciona una fecha');
      return;
    }
    if (!horarioBtn) {
      alert('Selecciona un horario');
      return;
    }
    
    const horarioId = horarioBtn.dataset.id;
    
    fetch('{% url "crear_turno" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        servicios: serviciosSeleccionados,
        empleado_id: empleadoId,
        fecha: fecha,
        horario_id: horarioId
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        alert('¡Turno solicitado con éxito!');
        bootstrap.Modal.getInstance(document.getElementById('modalTurno')).hide();
        serviciosSeleccionados = [];
      } else {
        alert('Error: ' + (data.error || 'No se pudo crear el turno'));
      }
    });
  });

  // Establecer fecha mínima (hoy)
  document.getElementById('inputFecha').min = new Date().toISOString().split('T')[0];
</script>
{% endblock %}