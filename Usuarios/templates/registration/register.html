{% extends 'base.html' %}
{% load static %}

{% block title %}Registrarse | Fede BarberShop{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center px-4 bg-[#0a0a0a] relative overflow-hidden">
  <div id="particles" class="absolute inset-0 z-0"></div>

  <div class="glass z-10 max-w-md w-full p-8 rounded-2xl shadow-xl text-white mt-20">
    <div class="text-center mb-6">
      <i class="fas fa-user-plus text-5xl text-yellow-500 mb-4"></i>
      <h1 class="text-2xl font-light tracking-widest uppercase">Registrarse</h1>
    </div>

    <form method="POST" class="space-y-4 text-yellow-500" id="form-register" novalidate>
      {% csrf_token %}
      {% for field in form %}
        <div class="relative">
            <label for="{{ field.id_for_label }}">
                {{ field.label }}
            </label>

            <div class="relative">
                {{ field }}

                {% if field.name == 'password1' or field.name == 'password2' %}
                    <span id="toggle-{{ field.name }}"
                          class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-yellow-500">
                        <i class="fas fa-eye-slash text-xl"></i>
                    </span>
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-yellow-500">
                        <i class="fas fa-lock text-xl"></i>
                    </span>

                {% elif field.name in 'username first_name last_name' %}
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-yellow-500">
                        <i class="fas fa-user text-xl"></i>
                    </span>

                {% elif field.name == 'email' %}
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-yellow-500">
                        <i class="fa-solid fa-envelope text-xl"></i>
                    </span>

                {% elif field.name == 'dni' %}
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-yellow-500">
                        <i class="fa-solid fa-passport text-xl"></i>
                    </span>

                {% elif field.name == 'telefono' %}
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-yellow-500">
                        <i class="fa-solid fa-phone text-xl"></i>
                    </span>
                {% endif %}
            </div>

            <!-- ERRORES DEL BACKEND -->
            {% if field.errors %}
                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
            {% endif %}

            <!-- ERRORES EN VIVO -->
            <span id="error-{{ field.name }}" class="text-red-500 text-sm"></span>

        </div>
      {% endfor %}


      <button type="submit"
        class="w-full py-3 bg-yellow-500 hover:bg-yellow-600 rounded-full font-semibold mt-6 text-black transition">
        Crear cuenta
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ======================
// Mostrar/Ocultar contraseña
// ======================
function togglePassword(fieldName) {
  const input = document.getElementById(`id_${fieldName}`);
  const toggle = document.getElementById(`toggle-${fieldName}`);
  if (!input || !toggle) return;

  toggle.addEventListener('click', () => {
    const isPass = input.type === "password";
    input.type = isPass ? "text" : "password";

    const icon = toggle.querySelector("i");
    icon.classList.toggle("fa-eye");
    icon.classList.toggle("fa-eye-slash");
  });
}

togglePassword("password1");
togglePassword("password2");


// ======================
// VALIDACIONES EN VIVO
// ======================

const reglas = {
  username: {
    regex: /^[A-Za-z0-9]+$/,
    msg: "Solo letras y números. Sin espacios."
  },
  first_name: {
    regex: /^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$/,
    msg: "Solo letras y espacios."
  },
  last_name: {
    regex: /^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$/,
    msg: "Solo letras y espacios."
  },
  email: {
    regex: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
    msg: "Correo electrónico inválido."
  },
  dni: {
    regex: /^[0-9]{7,10}$/,
    msg: "Debe contener entre 7 y 10 dígitos numéricos."
  },
  telefono: {
    regex: /^\+?\d{7,15}$/,
    msg: "Sólo números (puede comenzar con +)."
  }
};


document.querySelectorAll("input").forEach(input => {
  const name = input.name;
  const errorSpan = document.getElementById(`error-${name}`);

  if (!errorSpan || !reglas[name]) return;

  input.addEventListener("input", () => {
    const { regex, msg } = reglas[name];
    const value = input.value;

    if (value === "") {
      errorSpan.textContent = "";
      input.classList.remove("border-red-500");
      return;
    }

    if (!regex.test(value)) {
      errorSpan.textContent = msg;
      input.classList.add("border-red-500");
    } else {
      errorSpan.textContent = "";
      input.classList.remove("border-red-500");
    }
  });
});

// ======================
// Validación antes de enviar formulario
// ======================
document.getElementById("form-register").addEventListener("submit", function (e) {
  let valido = true;

  for (let name in reglas) {
    const input = document.querySelector(`[name="${name}"]`);
    if (!input) continue;

    const { regex } = reglas[name];
    const errorSpan = document.getElementById(`error-${name}`);

    if (!regex.test(input.value) && input.value !== "") {
      errorSpan.textContent = reglas[name].msg;
      valido = false;
    }
  }

  if (!valido) {
    e.preventDefault();
  }
});
</script>
{% endblock %}
