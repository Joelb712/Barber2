{% load static %}
<div class="form-container">
    <form id="form-cliente" class="ajax-form"
        action="{% if cliente %}{% url 'editar_cliente' cliente.pk %}{% else %}{% url 'formcli' %}{% endif %}"
        method="post" novalidate>

        {% csrf_token %}

        <p class="text-yellow-500 mb-3">Los campos con * son obligatorios</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            {% for field in form %}

            {% if field.name == 'activo' %}
            <div class="flex items-center text-yellow-400 mt-3 ml-1">
                {{ field }}
                <label for="{{ field.id_for_label }}" class="ml-2 block text-sm font-medium">
                    {{ field.label }}
                </label>
                <p class="text-red-500 text-xs mt-1" id="error_{{ field.name }}"></p>
            </div>

            {% else %}

            <div class="text-yellow-400 {% if field.name == 'notas' %}md:col-span-2{% endif %}">
                <label for="{{ field.id_for_label }}" class="block text-sm font-medium mb-1">
                    {{ field.label }}
                    {% if field.field.required %}
                    <span class="text-white font-semibold">*</span>
                    {% endif %}
                </label>

                <div class="relative">
                    {{ field }}

                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-yellow-400">
                        {% if field.name == 'first_name' %}<i class="fas fa-file-signature"></i>
                        {% elif field.name == 'last_name' %}<i class="fas fa-file-signature"></i>
                        {% elif field.name == 'dni' %}<i class="fas fa-id-card"></i>
                        {% elif field.name == 'telefono' %}<i class="fas fa-phone"></i>
                        {% endif %}
                    </span>
                </div>

                <p class="text-red-500 text-xs mt-1" id="error_{{ field.name }}"></p>
            </div>

            {% endif %}

            {% endfor %}
        </div>

        <div class="flex justify-around mt-6">
            <button type="button"
                class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150 ease-in-out"
                onclick="cerrarModalAjax();">
                Cancelar
            </button>

            <button id="btnGuardarCliente" type="submit"
                class="bg-green-500 hover:bg-green-600 text-black hover:text-white font-bold py-2 px-6 rounded-lg transition duration-150 ease-in-out">
                {% if cliente %} Guardar Cambios {% else %} Guardar {% endif %}
            </button>
        </div>
    </form>
</div>


<!-- ========================================================= -->
<!-- =============== SCRIPT DE VALIDACIONES ================== -->
<!-- ========================================================= -->

<script>
(function () {

    // Regex EXACTOS de formemp
    const regex = {
        nombre: /^[A-Za-zÁÉÍÓÚáéíóúñÑ ]+$/,
        apellido: /^[A-Za-zÁÉÍÓÚáéíóúñÑ ]+$/,
        dni: /^[0-9]{7,9}$/,
        telefono: /^[0-9]{7,15}$/
    };

    // Campos REALES del formulario de clientes
    const fieldMap = {
        first_name: "nombre",
        last_name: "apellido",
        dni: "dni",
        telefono: "telefono",
        activo: "activo"
    };

    function initClienteValidation(form) {
        if (!form) return;

        const btnGuardar = document.getElementById("btnGuardarCliente");

        function setError(name, msg) {
            const el = form.querySelector("#error_" + name);
            if (el) el.textContent = msg || "";

            const input = form.querySelector(`[name="${name}"]`);
            if (input) {
                if (msg) {
                    input.classList.add("border-red-500");
                } else {
                    input.classList.remove("border-red-500");
                }
            }
        }

        function validarCampoDOM(input) {
            if (!input) return true;

            const name = input.name;
            const val = (input.value || "").trim();

            if (!fieldMap.hasOwnProperty(name)) {
                setError(name, "");
                return true;
            }

            const tipo = fieldMap[name];

            // ------- VALIDACIONES -------
            if (tipo === "nombre" || tipo === "apellido") {
                if (!val) { setError(name, ""); return false; }
                if (!regex.nombre.test(val)) {
                    setError(name, "Solo letras, acentos y espacios.");
                    return false;
                }
            }

            else if (tipo === "dni") {
                if (!val) { setError(name, ""); return false; }
                if (!regex.dni.test(val)) {
                    setError(name, "DNI inválido (solo números).");
                    return false;
                }
            }

            else if (tipo === "telefono") {
                if (!val) { setError(name, ""); return false; }
                if (!regex.telefono.test(val)) {
                    setError(name, "Teléfono inválido (solo números).");
                    return false;
                }
            }

            setError(name, "");
            return true;
        }

        function validarTodo() {
            const inputs = Array.from(form.querySelectorAll("input, textarea, select"));
            let ok = true;

            inputs.forEach(inp => {
                const r = validarCampoDOM(inp);
                if (!r) ok = false;
            });

            if (btnGuardar) {
                btnGuardar.disabled = !ok;
                btnGuardar.classList.toggle("opacity-50", !ok);
            }

            return ok;
        }

        // Listeners
        const watchables = form.querySelectorAll("input, textarea, select");

        watchables.forEach(inp => {
            inp.addEventListener("input", () => {
                validarCampoDOM(inp);
                validarTodo();
            });
            inp.addEventListener("blur", () => {
                validarCampoDOM(inp);
                validarTodo();
            });
        });

        form.addEventListener("submit", function (e) {
            if (!validarTodo()) {
                e.preventDefault();
            }
        });

        validarTodo();
    }

    // Exponer globalmente si usás AJAX
    window.initClienteValidation = initClienteValidation;

    // Auto inicialización
    const f = document.getElementById("form-cliente");
    if (f) initClienteValidation(f);

})();
</script>
