{% load static %}
<div class="bg-neutral-900 text-gray-200 p-6 rounded-lg shadow-lg max-w-3xl mx-auto">
  <h2 class="text-2xl font-bold mb-4 text-yellow-400 text-center">Registrar Pago</h2>

  <p class="text-center text-sm mb-6">
    Venta #{{ venta.id }} — Total a pagar: 
    <span class="font-semibold text-green-400">${{ venta.total }}</span>
  </p>

  <form id="pagoForm" method="post" action="{% url 'registrar_pago' venta.id %}" class="space-y-4 ajax-form">
    {% csrf_token %}

    <div id="metodos-container" class="space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end metodo-item">
        <div>
          <label class="block text-yellow-400 mb-1 text-sm">Método de Pago</label>
          <select name="metodos[]" required
                  class="w-full rounded-lg bg-neutral-700 text-gray-100 border border-neutral-600 focus:ring-yellow-500 focus:border-yellow-500 p-2">
            <option value="">Seleccione</option>
            {% for m in metodos_pago %}
              <option value="{{ m.id }}">{{ m.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-yellow-400 mb-1 text-sm">Monto</label>
          <input type="number" step="0.01" name="montos[]" required
                 class="w-full rounded-lg bg-neutral-700 text-gray-100 border border-neutral-600 focus:ring-yellow-500 focus:border-yellow-500 p-2"
                 placeholder="0.00">
        </div>
        <div class="flex justify-center md:justify-end">
          <button type="button" onclick="agregarMetodo()"
                  class="bg-green-500 hover:bg-green-600 transition-colors text-white font-semibold py-2 px-4 rounded-lg w-full md:w-auto">
            +
          </button>
        </div>
      </div>
    </div>

    <div class="text-right pt-4">
      <button type="submit"
              class="bg-yellow-500 hover:bg-yellow-600 text-neutral-900 font-bold py-2 px-6 rounded-lg transition">
        Confirmar Pago
      </button>
    </div>
  </form>
</div>
<script>
(function () {
  // si el script se inyecta por AJAX, ejecutamos inmediatamente
  const totalVenta = parseFloat("{{ venta.total }}");
  const contenedor = document.getElementById("metodos-container");
  const btnSubmit = document.querySelector("#pagoForm button[type='submit']");

  function validarMontos() {
    const montos = [...document.querySelectorAll("input[name='montos[]']")];
    const selects = [...document.querySelectorAll("select[name='metodos[]']")];

    let suma = 0;
    let valido = true;

    montos.forEach((inp) => {
      let val = parseFloat(inp.value);
      if (isNaN(val) || val < 0) {
        inp.classList.add("border-red-500");
        valido = false;
        return;
      }
      if (val > totalVenta) {
        inp.classList.add("border-red-500");
        valido = false;
      } else {
        inp.classList.remove("border-red-500");
      }
      suma += val;
    });

    selects.forEach(s => { if (!s.value) valido = false; });

    if (Math.round(suma*100) !== Math.round(totalVenta*100)) valido = false;

    if (btnSubmit) {
      btnSubmit.disabled = !valido;
      btnSubmit.classList.toggle("opacity-50", !valido);
    }
    return valido;
  }

  function actualizarAutoMontos() {
    const montos = [...document.querySelectorAll("input[name='montos[]']")];
    let suma = 0;
    montos.forEach((inp, i) => {
      const val = parseFloat(inp.value) || 0;
      if (i < montos.length - 1) suma += val;
    });
    const faltante = totalVenta - suma;
    const ultimo = montos[montos.length - 1];
    if (ultimo) {
      ultimo.value = Math.max(0, faltante).toFixed(2);
    }
    validarMontos();
  }

  // Exponer globalmente para que onclick inline funcione
  window.agregarMetodo = function () {
    if (!contenedor) return;
    const nuevo = document.createElement("div");
    nuevo.className = "grid grid-cols-1 md:grid-cols-3 gap-3 items-end metodo-item";
    nuevo.innerHTML = `
      <div>
        <label class="block text-yellow-400 mb-1 text-sm">Método de Pago</label>
        <select name="metodos[]" required
                class="w-full rounded-lg bg-neutral-700 text-gray-100 border border-neutral-600 p-2">
          <option value="">Seleccione</option>
          {% for m in metodos_pago %}
            <option value="{{ m.id }}">{{ m.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-yellow-400 mb-1 text-sm">Monto</label>
        <input type="number" step="0.01" name="montos[]" required
               class="w-full rounded-lg bg-neutral-700 text-gray-100 border border-neutral-600 p-2"
               placeholder="0.00">
      </div>
      <div class="flex justify-center md:justify-end">
        <button type="button" class="btn-remove bg-red-600 hover:bg-red-700 transition-colors text-white font-semibold py-2 px-4 rounded-lg w-full md:w-auto">
          -
        </button>
      </div>
    `;
    contenedor.appendChild(nuevo);
    actualizarAutoMontos();
  };

  // delegación para botones de borrado creados dinámicamente
  document.addEventListener('click', function(e){
    if (e.target && (e.target.matches('.btn-remove') || e.target.closest('.btn-remove'))) {
      const btn = e.target.closest('.btn-remove');
      const item = btn.closest('.metodo-item');
      if (item) item.remove();
      actualizarAutoMontos();
      validarMontos();
    }
  });

  // cuando cambian selects o inputs
  document.addEventListener('input', function(e){
    if (e.target && e.target.name === 'montos[]') validarMontos();
  });
  document.addEventListener('change', function(e){
    if (e.target && e.target.name === 'metodos[]') actualizarAutoMontos();
  });

  // inicializar estado (si el HTML ya contiene filas)
  try { actualizarAutoMontos(); } catch(err){ /* ignore */ }
})();
</script>
