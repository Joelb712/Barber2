<!-- 
{% load static %}

<div class="container mt-4">
    <h3>Registrar Pago - Venta #{{ venta.id }}</h3>
    <p><strong>Cliente:</strong> {{ venta.cliente }}</p>
    <p><strong>Total a pagar:</strong> ${{ venta.total }}</p>

    <form method="post">
        {% csrf_token %}

        <div id="pagos-container">
            <div class="row mb-2 pago-item">
                <div class="col-md-6">
                    <select name="pagos[]" class="form-select metodo-pago">
                        <option value="">Seleccione método</option>
                        {% for m in metodos_pago %}
                        <option value="{{ m.id }}-0">{{ m.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="number" step="0.01" min="0" class="form-control monto-pago" 
                           onchange="updatePago(this)">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removePago(this)">X</button>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-secondary btn-sm" onclick="addPago()">Agregar método de pago</button>
        <br><br>
        <button type="submit" class="btn btn-success">Confirmar Pago</button>
    </form>
</div>

<script>
function addPago() {
    let container = document.getElementById("pagos-container");
    let row = container.querySelector(".pago-item").cloneNode(true);
    row.querySelector("select").value = "";
    row.querySelector(".monto-pago").value = 0;
    container.appendChild(row);
}

function removePago(btn) {
    let container = document.getElementById("pagos-container");
    if (container.querySelectorAll(".pago-item").length > 1) {
        btn.closest(".pago-item").remove();
    }
}

function updatePago(input) {
    let row = input.closest(".pago-item");
    let select = row.querySelector("select");
    let metodo_id = select.value.split("-")[0];
    select.value = metodo_id + "-" + input.value;
}
</script>
 -->

<!-- {% load static %}

<div class="container mt-4">
    <h3>Registrar Pago - Venta #{{ venta.id }}</h3>
    <p><strong>Cliente:</strong> {{ venta.cliente }}</p>
    <p><strong>Total a pagar:</strong> ${{ venta.total }}</p>

    <form id="pagoForm" method="post">
        {% csrf_token %}

        <div id="pagos-container">
            <div class="row mb-2 pago-item">
                <div class="col-md-6">
                    <select name="metodos[]" class="form-select" required>
                        <option value="">Seleccione método</option>
                        {% for m in metodos_pago %}
                        <option value="{{ m.id }}">{{ m.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="number" step="0.01" min="0" class="form-control" name="montos[]" required>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removePago(this)">X</button>
                </div>
            </div>
        </div>

        <button type="button" class="btn btn-secondary btn-sm" onclick="addPago()">Agregar método de pago</button>
        <br><br>
        <button type="submit" class="btn btn-success">Confirmar Pago</button>
    </form>
</div>

<script>
function addPago() {
    let container = document.getElementById("pagos-container");
    let row = container.querySelector(".pago-item").cloneNode(true);

    // Resetear valores al clonar
    row.querySelector("select").value = "";
    row.querySelector("input[name='montos[]']").value = 0;

    container.appendChild(row);
}

function removePago(btn) {
    let container = document.getElementById("pagos-container");
    if (container.querySelectorAll(".pago-item").length > 1) {
        btn.closest(".pago-item").remove();
    }
}
</script>
 -->

 <form id="pagoForm" method="post" action="{% url 'registrar_pago' venta.id %}" class="ajax-form">
    {% csrf_token %}
    <h5>Registrar Pago - Venta #{{ venta.id }}</h5>
    <p>Total a pagar: <strong>${{ venta.total }}</strong></p>

    <div id="metodos-container">
        <div class="row mb-2">
            <div class="col-md-6">
                <label>Método de Pago</label>
                <select name="metodos[]" class="form-select" required>
                    <option value="">Seleccione</option>
                    {% for m in metodos_pago %}
                        <option value="{{ m.id }}">{{ m.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label>Monto</label>
                <input type="number" step="0.01" name="montos[]" class="form-control" required>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-success w-100" onclick="agregarMetodo()">+</button>
            </div>
        </div>
    </div>

    <div class="text-end mt-3">
        <button type="submit" class="btn btn-primary">Confirmar Pago</button>
    </div>
</form>

<script>
function agregarMetodo(){
    const nuevo = `
    <div class="row mb-2">
        <div class="col-md-6">
            <select name="metodos[]" class="form-select" required>
                <option value="">Seleccione</option>
                {% for m in metodos_pago %}
                    <option value="{{ m.id }}">{{ m.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <input type="number" step="0.01" name="montos[]" class="form-control" required>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="button" class="btn btn-danger w-100" onclick="this.closest('.row').remove()">-</button>
        </div>
    </div>`;
    $('#metodos-container').append(nuevo);
}

// No hace falta este submit manual porque ya tenés:
// $(document).on('submit', '.ajax-form', ...)
// que manejará todo el envío y abrirá el siguiente modal si devuelve next_url
</script>
